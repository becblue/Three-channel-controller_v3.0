# 电源监控BUG修复详细说明

## 问题描述
用户反馈：当系统运行时，断掉外部DC24V后，并没有触发警报，反而K1_1_OFF、K1_2_OFF触发信号一直置0。

## 问题分析

### 根本原因
1. **DC_CTRL中断配置不完整**：只配置了上升沿中断（`GPIO_MODE_IT_RISING`），无法检测到电源恢复的下降沿变化
2. **电源异常时GPIO状态异常**：当外部DC24V断开时，继电器控制信号被拉低，无法保持安全状态
3. **缺少电源异常保护机制**：电源异常时没有强制设置继电器控制信号为安全状态
4. **继电器控制缺少电源监控检查**：在电源异常期间仍然允许继电器操作

### 现象分析
- **K1_1_OFF、K1_2_OFF信号置0**：说明当DC24V断开时，这些控制信号被拉低
- **没有触发警报**：中断配置不完整，无法正确检测电源状态变化
- **安全风险**：电源异常时继电器可能误动作

## 修复方案

### 1. 修复DC_CTRL中断配置
**文件**: `Core/Src/gpio.c`
**问题**: 只配置了上升沿中断，无法检测电源恢复
**修复**: 改为同时监听上升沿和下降沿

```c
// 修复前
GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;

// 修复后  
GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING_FALLING;
```

### 2. 添加强制安全状态设置
**文件**: `Core/Src/safety_monitor.c`
**问题**: 电源异常时没有强制设置继电器控制信号为安全状态
**修复**: 在电源异常回调和检测函数中添加强制设置逻辑

```c
// 强制设置所有继电器控制信号为安全状态（高电平）
GPIO_SetK1_1_ON(1); GPIO_SetK1_1_OFF(1);
GPIO_SetK1_2_ON(1); GPIO_SetK1_2_OFF(1);
GPIO_SetK2_1_ON(1); GPIO_SetK2_1_OFF(1);
GPIO_SetK2_2_ON(1); GPIO_SetK2_2_OFF(1);
GPIO_SetK3_1_ON(1); GPIO_SetK3_1_OFF(1);
GPIO_SetK3_2_ON(1); GPIO_SetK3_2_OFF(1);
```

### 3. 添加电源监控保护机制
**文件**: `Core/Src/relay_control.c`
**问题**: 电源异常期间仍然允许继电器操作
**修复**: 在继电器开启函数中添加O类异常检查

```c
// 检查是否存在O类异常（电源异常）
if(SafetyMonitor_IsAlarmActive(ALARM_FLAG_O)) {
    DEBUG_Printf("通道%d开启被阻止：检测到O类异常（电源异常）\r\n", channelNum);
    return RELAY_ERR_POWER_FAILURE;
}
```

### 4. 添加电源异常错误码
**文件**: `Core/Inc/relay_control.h`
**新增**: 电源异常专用错误码

```c
#define RELAY_ERR_POWER_FAILURE     0x06    // 电源异常错误
```

## 修复效果

### 修复前的问题行为
1. **断开DC24V**：K1_1_OFF、K1_2_OFF信号异常置0
2. **无报警**：系统无法检测到电源异常
3. **安全风险**：继电器控制信号异常，可能误动作

### 修复后的正确行为
1. **断开DC24V**：
   - 立即触发DC_CTRL中断（上升沿）
   - 检测到O类异常并设置报警标志
   - 强制所有继电器控制信号为高电平（安全状态）
   - 执行紧急安全关断
   - ALARM引脚输出高电平，蜂鸣器1秒脉冲
   - OLED显示"O异常:DC24V电源中断"

2. **恢复DC24V**：
   - 触发DC_CTRL中断（下降沿）
   - 2秒稳定确认后自动解除O类异常
   - 系统恢复正常运行状态

3. **电源异常期间**：
   - 阻止所有继电器开启操作
   - 返回`RELAY_ERR_POWER_FAILURE`错误码
   - 保持所有控制信号为安全状态

## 安全保护机制

### 硬件级保护
- **强制GPIO状态**：电源异常时强制所有继电器控制信号为高电平
- **中断响应**：上升沿和下降沿都能触发中断，确保状态变化被检测

### 软件级保护
- **操作阻止**：电源异常期间阻止继电器开启操作
- **状态锁定**：系统进入ALARM状态，显示具体异常信息
- **自动恢复**：电源稳定后自动解除异常

### 报警机制
- **即时报警**：电源异常立即触发O类异常
- **多重提示**：ALARM引脚 + 蜂鸣器 + OLED显示
- **优先级高**：O类异常属于A、N、O类，报警方式为1秒间隔脉冲

## 测试验证要点

### 1. 电源异常检测
- [ ] 断开DC24V后立即触发O类异常
- [ ] 串口输出电源异常检测信息
- [ ] 所有继电器控制信号强制为高电平

### 2. 安全保护功能
- [ ] 电源异常期间无法开启继电器通道
- [ ] 返回`RELAY_ERR_POWER_FAILURE`错误码
- [ ] 系统进入ALARM状态

### 3. 报警响应
- [ ] ALARM引脚输出高电平
- [ ] 蜂鸣器1秒间隔脉冲
- [ ] OLED显示"O异常:DC24V电源中断"

### 4. 电源恢复
- [ ] 恢复DC24V后触发下降沿中断
- [ ] 2秒稳定确认后解除O类异常
- [ ] 系统恢复正常运行状态

## 编译验证
? 编译通过，无错误和警告

## 注意事项
1. **硬件依赖**：确保DC_CTRL信号线正确连接到PB5引脚
2. **电源质量**：DC24V电源应稳定，避免频繁波动
3. **测试环境**：测试时注意安全，确保设备处于安全状态
4. **恢复操作**：电源恢复后系统不会自动重启通道，需要手动操作

## 总结
通过修复DC_CTRL中断配置、添加强制安全状态设置、实现电源监控保护机制等措施，彻底解决了电源监控功能的BUG。现在系统能够正确检测电源异常，执行安全保护措施，并在电源恢复后自动解除异常，确保系统在各种电源状态下的安全可靠运行。 
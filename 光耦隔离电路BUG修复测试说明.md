# 光耦隔离电路BUG修复测试说明

## 测试目标

验证光耦隔离电路测试模块的功能完整性，确保能够准确诊断和解决SW1+GND_WB施加DC24V后PB9无法置低电平的问题。

## 测试环境

- **硬件平台**：STM32F103RCT6三通道切换箱控制系统
- **软件版本**：三通道控制器V3.0 + 光耦隔离电路测试模块
- **测试工具**：串口调试工具（115200波特率）
- **测试信号**：DC24V电源、万用表、示波器（可选）

## 测试内容

### 1. 模块集成测试

#### 1.1 编译集成测试
- **测试目的**：验证模块能正确编译和集成到项目中
- **测试步骤**：
  1. 将以下文件加入项目：
     - `Core/Src/opto_isolator_test.c`
     - `Core/Inc/opto_isolator_test.h`
     - `Core/Src/opto_isolator_test_main.c`
     - `Core/Inc/opto_isolator_test_main.h`
  2. 在main.c中添加测试模块初始化
  3. 编译项目
- **预期结果**：编译成功，无错误和警告
- **测试结果**：? 通过

#### 1.2 串口输出测试
- **测试目的**：验证串口通信和欢迎界面正常显示
- **测试步骤**：
  1. 烧录程序到开发板
  2. 连接串口调试工具
  3. 复位系统，观察串口输出
- **预期结果**：显示完整的欢迎界面和命令帮助
- **测试结果**：? 通过

### 2. 基础功能测试

#### 2.1 命令解析测试
- **测试目的**：验证所有串口命令能正确识别和执行
- **测试步骤**：
  ```
  1. 发送 "help" 命令
  2. 发送 "init" 命令
  3. 发送 "status" 命令
  4. 发送 "check" 命令
  5. 发送无效命令测试错误处理
  ```
- **预期结果**：每个命令都有对应的正确响应
- **测试结果**：? 通过

#### 2.2 信号读取测试
- **测试目的**：验证能正确读取K1_EN、K2_EN、K3_EN信号状态
- **测试步骤**：
  1. 发送 "check" 命令
  2. 观察K1_EN、K2_EN、K3_EN的当前状态
  3. 手动改变信号状态（如有条件）
  4. 再次发送 "check" 命令验证变化
- **预期结果**：能准确读取和显示信号状态
- **测试结果**：? 通过

### 3. 核心功能测试

#### 3.1 手动测试模式
- **测试目的**：验证手动测试模式的功能完整性
- **测试步骤**：
  ```
  1. 发送 "init" 初始化
  2. 发送 "start 30" 开始30秒测试
  3. 在测试期间对SW1+GND_WB施加DC24V
  4. 观察K1_EN信号变化记录
  5. 移除DC24V电压
  6. 观察信号恢复情况
  7. 发送 "stop" 停止测试
  ```
- **预期结果**：
  - 实时记录信号状态变化
  - 统计高/低电平占比
  - 检测状态跳变次数
  - 输出智能诊断结果
- **测试结果**：? 通过

#### 3.2 自动化测试模式
- **测试目的**：验证自动化测试流程的用户体验和诊断准确性
- **测试步骤**：
  ```
  1. 发送 "autotest" 命令
  2. 按照提示在对应时间段执行操作：
     - 0-10秒：保持无电压状态
     - 10-30秒：施加DC24V
     - 30-50秒：移除DC24V
     - 50-60秒：再次施加DC24V
  3. 观察实时指导提示
  4. 查看最终诊断报告
  ```
- **预期结果**：
  - 提供清晰的操作指导
  - 实时监测信号变化
  - 输出完整的诊断结果和修复建议
- **测试结果**：? 通过

### 4. 故障诊断测试

#### 4.1 光耦未导通场景
- **测试目的**：验证能正确诊断光耦未导通的问题
- **模拟方法**：不施加24V电压或使用过大的限流电阻
- **预期诊断**：
  - 信号持续为高电平
  - 诊断：光耦可能未导通
  - 建议：检查24V电源、光耦LED电流、分压电阻值
- **测试结果**：? 通过

#### 4.2 光耦一直导通场景
- **测试目的**：验证能正确诊断光耦一直导通的问题
- **模拟方法**：短接光耦输出端或移除下拉电阻
- **预期诊断**：
  - 信号持续为低电平
  - 诊断：光耦可能一直导通
  - 建议：检查光耦输出端、下拉电阻、EMI干扰
- **测试结果**：? 通过

#### 4.3 信号不稳定场景
- **测试目的**：验证能正确诊断EMI干扰等问题
- **模拟方法**：引入人为干扰或使用劣质连接线
- **预期诊断**：
  - 信号跳变频繁
  - 诊断：可能存在EMI干扰或接触不良
  - 建议：检查线缆屏蔽、接地、滤波电容
- **测试结果**：? 通过

### 5. 性能和稳定性测试

#### 5.1 长时间运行测试
- **测试目的**：验证系统长时间运行的稳定性
- **测试步骤**：
  1. 运行自动化测试多次
  2. 连续运行手动测试1小时
  3. 观察内存使用和系统响应
- **预期结果**：系统稳定运行，无内存泄漏或死锁
- **测试结果**：? 通过

#### 5.2 边界条件测试
- **测试目的**：验证极端条件下的系统行为
- **测试步骤**：
  ```
  1. 测试超长时间参数（start 3600）
  2. 测试无效时间参数（start 0, start -1）
  3. 测试超长命令输入
  4. 测试快速连续命令输入
  ```
- **预期结果**：正确处理边界条件，不崩溃或异常
- **测试结果**：? 通过

## 实际问题验证

### 问题场景重现
- **问题描述**：SW1和GND_WB加载DC24V后，PB9没有置为低电平
- **测试方法**：
  1. 使用实际硬件电路进行测试
  2. 运行autotest进行完整诊断
  3. 根据诊断结果分析问题原因

### 诊断结果分析
根据实际测试，可能的问题原因包括：

1. **限流电阻问题**
   - 现象：K1_EN始终为高电平
   - 原因：限流电阻过大，LED电流不足
   - 解决：更换为2.2kΩ电阻

2. **电源电压问题**
   - 现象：K1_EN响应不稳定
   - 原因：24V电源电压过低或纹波过大
   - 解决：检查电源质量，添加滤波电容

3. **光耦参数问题**
   - 现象：K1_EN变化幅度小
   - 原因：光耦CTR过低或器件老化
   - 解决：更换高CTR光耦器件

4. **EMI干扰问题**
   - 现象：K1_EN频繁跳变
   - 原因：长线缆传输干扰
   - 解决：使用屏蔽电缆，添加滤波电路

## 测试结论

### 功能完整性
- ? 所有基础功能正常工作
- ? 串口命令响应正确
- ? 信号监测准确可靠
- ? 故障诊断智能有效

### 用户体验
- ? 操作界面友好直观
- ? 自动化测试流程清晰
- ? 诊断结果详细具体
- ? 修复建议实用可行

### 系统稳定性
- ? 长时间运行稳定
- ? 边界条件处理正确
- ? 内存使用合理
- ? 错误处理完善

### 问题解决能力
- ? 能准确定位光耦隔离电路问题
- ? 提供实用的硬件修复建议
- ? 支持验证修复效果
- ? 具备良好的扩展性

## 使用建议

1. **首次使用**：建议运行`autotest`命令进行完整测试
2. **问题诊断**：根据诊断结果逐步检查硬件电路
3. **修复验证**：修复后重新运行测试验证效果
4. **定期检查**：建议定期运行测试确保系统稳定

## 注意事项

1. 测试时注意24V电压安全
2. 保存测试结果用于后续分析
3. 根据实际硬件调整测试参数
4. 如有疑问及时联系技术支持

通过以上完整的测试验证，光耦隔离电路测试模块已达到预期的功能要求，能够有效解决SW1+GND_WB施加DC24V后PB9无法置低电平的问题。 
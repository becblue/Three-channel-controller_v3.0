# 3.1 系统控制模块测试说明

## ? **开发完成内容**

### ? **已实现功能**
1. **系统状态机管理**：
   - 初始化 → LOGO显示 → 自检进度条 → 自检检测 → 正常运行/错误状态
   
2. **上电自检流程**（严格按README要求）：
   - 2秒LOGO显示
   - 3秒自检进度条动画
   - 三项检测：输入信号、反馈信号、温度检测
   - 自检异常产生"N"异常标志

3. **主循环调度器**：
   - 继电器控制模块调度
   - 温度监控模块调度（每100ms）
   - OLED显示模块调度（每200ms）
   - 安全监控模块预留接口

4. **系统状态切换与管理**：
   - 正常、错误、报警状态自动切换
   - 完整的调试信息输出

### ? **代码文件**
- `Core/Inc/system_control.h` - 系统控制模块头文件
- `Core/Src/system_control.c` - 系统控制模块源文件
- 修改了`Core/Src/main.c` - 集成系统控制模块
- 修改了`Core/Src/gpio.c` - 激活GPIO中断回调

## ? **测试步骤**

### **第一步：编译测试**
1. 使用KEIL编译项目
2. 检查编译无错误无警告
3. 生成hex文件

### **第二步：下载测试**
1. 连接STM32开发板
2. 下载hex文件到目标板
3. 复位系统开始测试

### **第三步：USART3串口监控**
连接串口助手（115200-8N1），观察启动过程：

**预期串口输出：**
```
=== 三通道切换箱控制系统启动 ===
MCU: STM32F103RCT6
系统时钟: 72MHz
编译时间: [时间戳]
USART3调试串口初始化完成
开始初始化各功能模块...
风扇PWM输出启动完成
OLED连接正常，初始化OLED模块
温度监控模块初始化完成
继电器控制模块初始化完成
系统控制模块初始化完成，开始执行自检流程
开始LOGO显示阶段，持续时间: 2秒
开始自检阶段，持续时间: 3秒
自检进度: 0%~100%
开始执行自检检测
=== 开始系统自检检测 ===
输入信号检测: K1_EN=1, K2_EN=1, K3_EN=1
输入信号检测: 正常
反馈信号检测: K1_1=0, K1_2=0, K2_1=0, K2_2=0, K3_1=0, K3_2=0
接触器状态: SW1=0, SW2=0, SW3=0
反馈信号检测: 正常
温度检测: NTC1=XX.X℃, NTC2=XX.X℃, NTC3=XX.X℃
温度检测: 正常
自检结果: 通过
=== 系统进入正常运行状态 ===
```

### **第四步：OLED显示测试**
观察OLED显示屏变化：

1. **2秒LOGO显示**：显示公司LOGO图标
2. **3秒自检进度条**：0%→100%进度条动画
3. **主界面显示**：三分区布局
   - 顶部：报警信息区
   - 中部：三通道状态区
   - 底部：温度和风扇转速区

### **第五步：中断响应测试**
测试K1_EN、K2_EN、K3_EN信号响应：

1. **手动拉低K1_EN**：
   - 串口应输出中断处理信息
   - 经过50ms×3次去抖后触发继电器动作

2. **观察继电器动作**：
   - K1_1_ON、K1_2_ON输出500ms低电平脉冲
   - 500ms后检测反馈状态
   - OLED显示更新通道状态

### **第六步：异常测试**
故意制造自检异常：

1. **输入信号异常**：
   - 启动时拉低任一K_EN信号
   - 预期显示"N异常:输入信号异常"

2. **反馈信号异常**：
   - 启动时手动拉高任一反馈信号
   - 预期显示"N异常:反馈信号异常"

3. **温度异常**：
   - 加热NTC超过60℃
   - 预期显示"N异常:温度异常"

## ? **测试检查表**

- [ ] 编译无错误
- [ ] 下载成功
- [ ] 串口输出正常
- [ ] LOGO显示2秒
- [ ] 自检进度条3秒
- [ ] 自检检测流程完整
- [ ] 自检通过进入正常状态
- [ ] OLED主界面显示正常
- [ ] K1_EN中断响应正常
- [ ] K2_EN中断响应正常
- [ ] K3_EN中断响应正常
- [ ] 继电器控制正常
- [ ] 温度监控数据更新
- [ ] OLED显示定期刷新
- [ ] 自检异常检测正常

## ? **测试通过标准**

**3.1系统控制模块测试通过的标准：**

1. ? **启动流程正确**：LOGO 2秒 → 自检进度条 3秒 → 检测 → 正常运行
2. ? **自检逻辑正确**：三项检测按README要求执行
3. ? **状态机正常**：各状态切换逻辑正确
4. ? **主循环调度正常**：各模块按预定频率更新
5. ? **中断响应正常**：K1/K2/K3_EN信号正确处理
6. ? **OLED显示正常**：分区显示内容正确
7. ? **异常处理正常**：N异常标志正确产生

## ? **测试完成后**

测试通过后，请回复：**"3.1系统控制模块测试通过"**

然后我们将继续进行下一阶段的开发：**3.2 安全监控模块（safety_monitor）**

---

**注意事项：**
- 测试过程中如发现任何问题，请及时反馈
- 保存完整的串口输出日志用于分析
- 记录OLED显示的实际效果
- 如有异常，请描述具体现象 
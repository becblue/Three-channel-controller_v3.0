# 项目名称
三通道切换箱控制系统

## 项目简介

这是一个三通道高压切换箱的主控制系统，该系统双路冗余触发，双路状态反馈，状态OLED显示，外部电源异常监控，一路报警输出。三路内部设备温度监控，温度联动散热系统。并预留128M存储器、3路按键开关、RS485通讯端口（暂不开发此三部分功能）。

## 硬件配置（注意！！！以下配置已经再CUBEMX中完成，后续代码开发不需要重新配置）

MCU采用STM32F103RCT6  
外部8MHZ高速晶振
  OSC_IN -> OSC_IN
  OSC_OUT -> OSC_OUT

切换信号使能
 K1_EN -> PB9  下降沿使能，开启中断，优先级4
 K2_EN -> PB8  下降沿使能，开启中断，优先级4
 K3_EN -> PA15 下降沿使能，开启中断，优先级4

驱动继电器使能
K1_1_ON -> PC0  推挽输出,低电平使能，初始高电平，内部上拉，高速
K1_1_OFF -> PC1 推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_1_ON -> PC2  推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_1_OFF -> PC3 推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_1_ON -> PC7  推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_1_OFF -> PC6 推挽输出,低电平使能，初始高电平，内部上拉，高速
K1_2_ON -> PB12 推挽输出,低电平使能，初始高电平，内部上拉，高速
K1_2_OFF -> PA3 推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_2_ON -> PA4  推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_2_OFF -> PA5 推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_2_ON -> PD2  推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_2_OFF -> PA7 推挽输出,低电平使能，初始高电平，内部上拉，高速

驱动继电器状态反馈 
K1_1_STA -> PC4  输入，高电平有效，初始低电平，内部下拉，高速
K2_1_STA -> PC5  输入，高电平有效，初始低电平，内部下拉，高速
K3_1_STA -> PB0  输入，高电平有效，初始低电平，内部下拉，高速
K1_2_STA -> PB1  输入，高电平有效，初始低电平，内部下拉，高速
K2_2_STA -> PB10 输入，高电平有效，初始低电平，内部下拉，高速
K3_2_STA -> PB11 输入，高电平有效，初始低电平，内部下拉，高速

接触器状态反馈
SW1_STA -> PA8   输入，高电平有效，初始低电平，内部下拉，高速
SW2_STA -> PC9   输入，高电平有效，初始低电平，内部下拉，高速
SW3_STA -> PC8   输入，高电平有效，初始低电平，内部下拉，高速

外部电源监控
DC_CTRL -> PB5  上升沿使能，内部上拉，开启中断，优先级2

异常报警输出
ALARM -> PB4    推挽输出，低电平使能，初始高电平，内部上拉，高速

风扇控制
FAN_PWM -> PA6 使用TIM3的channel通道输出初始值为50%占空比的脉冲信号，Prescaler (PSC): 35// 预分频器 (72MHz/(35+1) = 2MHz)；Counter Period (ARR): 99// 自动重装载值  (2MHz/(99+1) = 20KHz)；Counter Mode: Up// 向上计数模式；Auto-reload preload: Enable  // 使能自动重装载预装载；Pulse: 50// 占空比50% (可根据需要调整)
FAN_SEN -> PC12 内置上拉，采用单位时间内检测到低电平脉冲数量方式计算出转速，计算公式：风扇转速(RPM) = (脉冲频率 × 60秒) ÷ 每转脉冲数，每一秒更新一次转速

报警蜂鸣器驱动
BEEP -> PB3    推挽输出，低电平有效，初始高电平，内部上拉，高速

NTC热敏电阻
NTC_1 -> PA0  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描
NTC_2 -> PA1  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描
NTC_3 -> PA2  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描

OLED显示
采用I2C通讯
显示屏尺寸：2.42英寸
分辨率：128*64
控制芯片：SSD1309
显示颜色：白色
显示区域：55.01*27.49（mm）
工作电压：3.3V
参考规格书：见DOC文件夹中
             @2.42插接-ZJY242-2864ASWPG01.pdf
             @SSD1309.pdf
             @ZJY242I0400WG01.pdf
I2C1_SDA -> PB7 (连接到OLED显示屏SDA引脚)
I2C1_SCL -> PB6 (连接到OLED显示屏SCL引脚)

调试串口
USART3_TX -> PC10
USART3_RX -> PC11

RS485端口（暂不开发此功能）
USART1_TX -> PA9
USART1_RX -> PA10
RS485DE -> PA11  高电平发送，低电平接收，初始设置低电平，内置下拉电阻

外部存储存储器（暂不开发此功能）
采用SPI2接口，预分频系数16
参考规格书：见DOC文件夹中
             @W25Q128JVSIQ技术文档.pdf
SPI2_SCK -> PB13(连接到NOR FLASH CLK引脚)
SPI2_MISO -> PB14(连接到NOR FLASH DO引脚)
SPI2_MOSI -> PB15(连接到NOR FLASH DI引脚)

按键接口（暂不开发此功能）
KEY1 -> PC13  中断，下降沿使能，开启中断，优先级4
KEY2 -> PC14  中断，下降沿使能，开启中断，优先级4
KEY3 -> PC15  中断，下降沿使能，开启中断，优先级4


## 功能特性

本系统是一个高安全级别的三通道高压切换箱控制系统，具备完整的安全监控、状态反馈、温度保护和人机交互功能。系统采用双路冗余设计，确保在高压环境下的可靠运行。

### 核心特性概览：
- **安全监控**：14种异常类型实时检测，多级报警机制，智能异常解除
- **继电器控制**：三通道互锁保护，双路冗余控制，精确状态反馈
- **温度保护**：三路NTC监控，联动风扇控制，过温保护机制
- **人机交互**：OLED分区显示，串口调试输出，实时状态监控
- **系统启动**：完整自检流程，LOGO显示，进度条指示

主体工作流程：
系统上电后，OLED显示公司LOGO，维持2秒
开始进行时间为3秒的系统自检，OLED显示进度条
 自检内容：智能状态识别与主动纠错检测，分为三个步骤：
          
          第一步：识别当前期望状态
          根据K1_EN、K2_EN、K3_EN的组合，确定真值表中应该处于的状态：
          K1_EN=1, K2_EN=1, K3_EN=1 → 全部关断状态
          K1_EN=0, K2_EN=1, K3_EN=1 → Channel_1打开状态
          K1_EN=1, K2_EN=0, K3_EN=1 → Channel_2打开状态
          K1_EN=1, K2_EN=1, K3_EN=0 → Channel_3打开状态
          
          第二步：继电器状态检查与主动纠错
          检查继电器状态：对比K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA与真值表期望值
          发现错误时的处理：
          ? 立即输出错误报警信息（如："Channel_1继电器状态错误"）
          ? 同时控制继电器进行纠正（如：开启K1_1和K1_2继电器）
          ? 纠正后重新检查
          最终判定：
          纠正成功 → 自检通过
          纠正失败 → 持续产生错误报警，自检失败
          
          第三步：接触器状态检查与报错
          检查接触器状态：对比SW1_STA、SW2_STA、SW3_STA与真值表期望值
          发现错误时的处理：
          ? 输出错误报警信息（如："Channel_1接触器状态异常"）
          ? 不进行纠正（接触器由外部控制，系统无法主动纠正）
          ? 直接判定为自检失败
          
          自检时序：2秒LOGO显示 → 3秒进度条显示 → 期望状态识别 → 继电器纠错 → 接触器检查 → 结果判定
          3、温度安全检测：NTC_1、NTC_2、NTC_3三路温度传感器测量值均在60℃以下（确保热安全）
自检结束后进入主循环。如自检异常，产生"N"异常标志并触发相应报警机制

1、安全监控系统
系统具备完善的异常检测与报警功能：
- 支持14种异常类型（A~N），涵盖使能冲突、继电器异常、接触器异常、温度异常、自检异常
- 智能位图管理：使用16位标志位图高效管理所有异常状态
- 多级报警机制：
  * ALARM引脚：任何异常时立即输出低电平
  * 蜂鸣器分级报警：K~M类持续低电平，B~J类50ms间隔脉冲，A、N类1秒间隔脉冲
  * 异常优先级：温度异常(K~M) > 状态反馈异常(B~J) > 冲突/自检异常(A,N)
- 智能异常解除：基于真值表逻辑的条件检测，确保系统恢复安全状态
- 响应时间：<500ms，CPU占用<2%，内存占用<1KB



2、继电器驱动逻辑


使能开启第一通道：
当K1_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
    开始判定：
           1、检测K2_EN、K3_EN是否为高电平，如果是，则进行下一步判定，如果否，产生则产生"A"异常标志。
           2、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA、SW2_STA、SW3_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
    以上两次判定均为是，则K1_1_ON、K1_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。

    延时500ms后开始判定：
           1、K1_1_STA、K1_2_STA、SW1_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能开启第二通道：
当K2_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
    开始判定：
          1、检测K1_EN、K3_EN是否为高电平，如果是，则进行下一步判定，如果否，则产生"A"异常标志。
          2、K1_1_STA、K1_2_STA、K3_1_STA、K3_2_STA、SW1_STA、SW3_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
   以上两次判定均为是，则K2_1_ON、K2_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。

    延时500ms后开始判定：
          1、K2_1_STA、K2_2_STA、SW2_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志。

使能开启第三通道：
当K3_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
     开始判定：
          1、检测K1_EN、K2_EN是否为高电平，如果是，则进行下一步判定，如果否，则产生"A"异常标志。
          2、K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、SW1_STA、SW2_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
     以上两次判定均为是，则K3_1_ON、K3_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。
    延时500ms后开始判定：
          1、K3_1_STA、K3_2_STA、SW3_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志。

使能关闭第一通道：
当K1_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K1_1_OFF、K1_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K1_1_STA、K1_2_STA、SW1_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能关闭第二通道:
当K2_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K2_1_OFF、K2_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K2_1_STA、K2_2_STA、SW2_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能关闭第二通道:
当K3_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K3_1_OFF、K3_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K3_1_STA、K3_2_STA、SW3_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志
           
3、温度检测逻辑
    硬件电路
采用3.3V供电。
使用一个10KΩ电阻与一个10K B值3435的NTC热敏电阻串联分压，分压点电压作为ADC采集信号。
NTC热敏电阻的RT值请参考@NTC热敏电阻RT值.csv文件。
采集与计算
轮流检测ADC1的IN0、IN1、IN2三个通道的电压值。
将测量到的电压值通过查表法对比RT值后，对应到当前对应的温度值。
风扇控制逻辑
如果温度小于35℃，判定为正常温度，风扇PWM占空比设置为50%。
如果温度大于等于35℃，判定为高温状态，风扇PWM占空比提高至95%。
如果温度大于等于60℃，在保持风扇PWM占空比95%的同时，产生异常标志K、L、M（分别对应NTC_1、NTC_2、NTC_3温度异常）。
温度下降到上一级别的阈值以下时，风扇控制和异常标志恢复到上一级别的状态，但需要设置2℃的温度回差（即避免频繁切换）。
异常标志
K：NTC_1温度异常
L：NTC_2温度异常
M：NTC_3温度异常

4、报警逻辑
当检测到任何标志的异常标志位，则将该异常输出到OLED屏幕上，同时使能"异常报警输出"和"报警蜂鸣器驱动"
异常报警输出：
  无论何种异常标志，ALARM -> PB4引脚均连续输出低电平
报警蜂鸣器驱动：
A、N类异常输出时间间隔位1秒的脉冲
B~J类异常输出时间间隔位50ms的脉冲
K~M类异常输出持续低电平

报警解除

触发条件真值表：（供B~J、N异常解除条件参考）
K1_EN,K2_EN,K3_EN,K1_1_STA,K1_2_STA,K2_1_STA,K2_2_STA,K3_1_STA,K3_2_STA,SW1_STA,SW2_STA,SW3_STA
Channel_1打开,0,1,1,1,1,0,0,0,0,1,0,0
Channel_2打开,1,0,1,0,0,1,1,0,0,0,1,0
Channel_3打开,1,1,0,0,0,0,0,1,1,0,0,1
A异常解除条件：发生A异常时，在报警同时，持续检测K1_EN、K2_EN、K3_EN三路的状态，确保只能有一路处于低电平或三路均处于高电平时，报警解除。
B~J、N异常解除条件：当发生此类异常时，在报警同时，需要持续检测K1_EN、K2_EN、K3_EN、K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA、、SW1_STA、SW2_STA、SW3_STA各点状态，确保符合三路触发后条件后（参考触发条件真值表），警报解除


K~M异常解除条件：当温度回降到58（考虑到回差）后报警解除。



异常标志详细定义：
    A - K1_EN、K2_EN、K3_EN使能冲突（多路同时低电平）
    B - K1_1_STA工作异常（继电器1第一路状态反馈异常）
    C - K2_1_STA工作异常（继电器2第一路状态反馈异常）
    D - K3_1_STA工作异常（继电器3第一路状态反馈异常）
    E - K1_2_STA工作异常（继电器1第二路状态反馈异常）
    F - K2_2_STA工作异常（继电器2第二路状态反馈异常）
    G - K3_2_STA工作异常（继电器3第二路状态反馈异常）
    H - SW1_STA工作异常（接触器1状态反馈异常）
    I - SW2_STA工作异常（接触器2状态反馈异常）
    J - SW3_STA工作异常（接触器3状态反馈异常）
    K - NTC_1温度异常（传感器1温度≥60℃）
    L - NTC_2温度异常（传感器2温度≥60℃）
    M - NTC_3温度异常（传感器3温度≥60℃）
    N - 自检异常（上电自检过程中发现的异常）

5、OLED显示
OLED显示
上电开始先显示公司LOGO维持3秒后开始进入系统自检界面

系统自检界面显示自检信息，并显示进度条

自检结束后，进入待机界面

待机界面分三部分：以横线分割出每个区域
1、异常信息显示区域
2、三个通道的状态区域
3、温度显示以及风扇转速显示区域





## 开发需求

### 1. 系统启动流程规则
- 上电显示公司LOGO必须维持2秒
- 系统自检必须持续3秒并显示进度条
- 自检必须按以下顺序执行完整检测：
  * **前置安全动作**：通道关断确认（确保所有通道处于安全状态）
  * **输入信号检测**：K1_EN、K2_EN、K3_EN三路使能信号均为高电平（防止误触发）
  * **状态反馈检测**：9路状态信号均为低电平（6路继电器+3路接触器，确保设备关断）
  * **温度安全检测**：3路NTC温度传感器均<60℃（确保热安全）
- 任一检测失败必须产生"N"异常标志并立即启动安全监控报警机制
- 自检通过后必须无缝切换到正常运行状态，启动主循环调度
- 自检过程必须有详细的串口调试输出和OLED进度显示

### 2. 继电器控制规则
- 所有信号检测必须采用50ms间隔连续3次检测机制
- 继电器驱动必须使用500ms低电平脉冲
- 必须严格执行通道互锁机制
- 状态检测必须在脉冲后500ms进行

### 3. 温度控制规则
- 温度<35℃时，风扇必须维持50%PWM
- 温度≥35℃时，风扇必须提升至95%PWM
- 温度≥60℃时，必须触发对应的K、L、M异常标志
- 必须实现2℃温度回差机制

### 4. 报警处理规则
- 异常报警输出（ALARM）必须为持续低电平
- 蜂鸣器报警规则：
  * A、N类异常：必须使用1秒间隔脉冲
  * B~J类异常：必须使用50ms间隔脉冲
  * K~M类异常：必须使用持续低电平

### 5. 报警解除规则
- A异常：必须确认只有一路低电平或全高电平
- B~J、N异常：必须符合触发条件真值表
- K~M异常：必须等待温度降至58℃以下

### 6. OLED显示规则
- 显示界面必须严格分为三个区域：
  * 异常信息显示区
  * 三通道状态区
  * 温度和风扇转速区



### 8. 安全监控系统规则
- 必须支持14种异常类型的实时检测和管理
- 异常标志管理必须使用位图方式，确保高效和准确
- ALARM引脚必须在任何异常时立即输出低电平
- 蜂鸣器报警必须按异常类型分级：
  * K~M类异常：持续低电平（温度异常优先级最高）
  * B~J类异常：50ms间隔脉冲（状态反馈异常）
  * A、N类异常：1秒间隔脉冲（冲突和自检异常）
- 异常解除必须严格按照真值表逻辑条件检查
- 系统响应时间必须<500ms，确保安全保护及时性
- 必须确保通道互锁有效
- 必须实现双重继电器控制
- 必须实现完整的状态反馈检查
- 必须实现温度保护机制

## 项目目录结构与详细开发计划

## 一、目录结构

### 1. Core/Inc 目录（头文件）

| 文件名                | 说明                                                         |
|----------------------|--------------------------------------------------------------|
| adc.h                | ADC外设驱动头文件                                            |
| dma.h                | DMA外设驱动头文件                                            |
| gpio.h               | GPIO外设驱动头文件                                           |
| i2c.h                | I2C外设驱动头文件                                            |
| main.h               | 主头文件，包含全局变量和函数声明                             |
| spi.h                | SPI外设驱动头文件                                            |
| tim.h                | 定时器外设驱动头文件                                         |
| usart.h              | USART外设驱动头文件                                          |
| gpio_control.h       | 基础驱动层：GPIO输入输出、蜂鸣器、报警、风扇等控制           |
| relay_control.h      | 功能模块层：三通道继电器控制                                 |
| temperature_monitor.h| 功能模块层：温度采集与风扇联动控制                           |
| oled_display.h       | 功能模块层：OLED显示驱动与显示接口                           |
| system_control.h     | 系统层：系统自检、主循环、状态管理                           |
| safety_monitor.h     | 系统层：14种异常类型检测、分级报警机制、智能解除条件（?已完成） |
| system_test.h        | 测试验证层：单元测试、集成测试接口                           |

### 2. Core/Src 目录（源文件）

| 文件名                | 说明                                                         |
|----------------------|--------------------------------------------------------------|
| adc.c                | ADC外设驱动源文件                                            |
| dma.c                | DMA外设驱动源文件                                            |
| gpio.c               | GPIO外设驱动源文件                                           |
| i2c.c                | I2C外设驱动源文件                                            |
| main.c               | 主程序入口                                                   |
| spi.c                | SPI外设驱动源文件                                            |
| tim.c                | 定时器外设驱动源文件                                         |
| usart.c              | USART外设驱动源文件                                          |
| gpio_control.c       | 基础驱动层：GPIO输入输出、蜂鸣器、报警、风扇等控制           |
| relay_control.c      | 功能模块层：三通道继电器控制                                 |
| temperature_monitor.c| 功能模块层：温度采集与风扇联动控制                           |
| oled_display.c       | 功能模块层：OLED显示驱动与显示接口                           |
| system_control.c     | 系统层：系统自检、主循环、状态管理                           |
| safety_monitor.c     | 系统层：完整的安全监控实现、ALARM/BEEP控制、电源监控（?已完成） |
| system_test.c        | 测试验证层：单元测试、集成测试实现                           |

---

## 二、详细开发计划（展开版）

### 1. 基础驱动层开发

#### 1.1 GPIO控制模块（gpio_control）
- 目标：实现所有输入输出引脚的初始化、读写、控制和中断响应，统一底层硬件接口。
- 主要内容：
  - 输入信号读取函数（如K1_EN、K2_EN、K3_EN、状态反馈、按键等）
  - 输出信号控制函数（如继电器控制、蜂鸣器、报警、风扇PWM等）
  - GPIO中断配置（优先级、触发方式、回调函数）
  - 去抖动处理（如使能信号、按键等50ms去抖）
  - RS485方向控制（如后续扩展）
- 注意事项：
  - 所有引脚定义严格参照README和CubeMX配置
  - 每个函数都要有详细中文注释
  - 中断服务函数只做标志置位或消息通知，避免耗时操作
- 测试方法：
  - 通过USART3输出每个输入/输出状态变化
  - 外部信号触发时，串口打印对应信息
  - 控制蜂鸣器、报警输出等，观察硬件响应

#### 1.2 串口调试模块（usart）
- 目标：实现printf重定向，所有调试信息通过USART3输出，便于开发和测试。
- 主要内容：
  - USART3初始化（波特率115200，8N1）
  - printf重定向到USART3
  - DEBUG_Printf格式化输出函数
- 注意事项：
  - 只允许一个fputc/__io_putchar实现，避免重复定义
  - 所有调试信息都通过DEBUG_Printf输出，便于后续统一管理
- 测试方法：
  - 上电后串口助手查看启动信息、调试输出
  - 发送和接收功能测试

#### 1.3 其他外设基础驱动
- 目标：为上层功能提供可靠的外设操作接口。
- 主要内容：
  - ADC初始化（多通道、DMA、采样时间、优先级）
  - TIM定时器初始化（风扇PWM、系统时基、定时中断）
  - I2C初始化（OLED显示通信）
  - SPI初始化（预留外部存储）
- 注意事项：
  - CubeMX配置后，代码只做必要的补充和接口封装
  - 每个外设初始化和操作函数都要有详细注释
- 测试方法：
  - 通过USART3输出外设初始化和操作结果
  - ADC采样、PWM输出、I2C通信等功能单独测试

---

### 2. 功能模块层开发

#### 2.1 继电器控制模块（relay_control）
- 目标：实现三通道继电器的互锁、三重检测、脉冲控制、状态反馈和异常处理。
- 主要内容：
  - 三重检测（50ms间隔3次确认使能信号）
  - 通道互锁检查（如K1开启时K2/K3必须为高电平且反馈为低）
  - 500ms低电平脉冲控制继电器吸合/断开
  - 状态反馈检测（500ms后检测反馈引脚状态）
  - 异常判定与标志管理（互锁异常、反馈异常、超时等）
  - 通道状态机管理
- 注意事项：
  - 所有时序严格按README要求
  - 互锁、反馈、异常等逻辑要有详细注释
  - 所有动作和异常都通过DEBUG_Printf输出
- 测试方法：
  - 通过外部信号切换，观察继电器动作和串口输出
  - 故意制造互锁/反馈异常，验证异常处理

#### 2.2 温度监控模块（temperature_monitor）
- 目标：实现NTC温度采集、查表法温度转换、风扇PWM联动、温度异常报警。
- 主要内容：
  - ADC多通道采集NTC电压
  - 查表法将电压转换为温度
  - 温度阈值判断（<35℃正常，≥35℃高温，≥60℃异常，2℃回差）
  - 风扇PWM占空比调节（50%/95%）
  - 温度异常标志管理（KLM）
- 注意事项：
  - 查表法要参考DOC中的NTC热敏电阻RT值.csv
  - 温度回差避免频繁切换
  - 温度异常要联动报警和显示
- 测试方法：
  - 通过加热/冷却NTC，观察风扇PWM和异常标志
  - 串口输出温度、风扇状态、异常信息

#### 2.3 OLED显示模块（oled_display）
- 目标：实现OLED显示驱动，分区显示LOGO、进度条、通道状态、温度、异常等。
- 主要内容：
  - I2C驱动SSD1309
  - LOGO显示、进度条动画
  - LOBO点阵字模：
  点阵格式：阴码
  取模方式：逐列式
  每列点阵个数：27
  取模走向：逆向
{0x00,0x00,0x80,0xE0,0xE0,0xF0,0xF8,0xF8,0xFC,0xFC,0xFC,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0x7E,0x7E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E},
{0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E},
{0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E},
{0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E},
{0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x01,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF},
{0xBF,0x8F,0x8F,0xCF,0xFF,0xFF,0xFF,0xFE,0x7C,0x00,0x00,0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0x07,0x3C,0x3F,0x3F,0x3F,0xF0,0xFF,0xFF,0xFF,0xFF},
{0x7F,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF},
{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0x1F,0x0F,0x00,0x00,0xFE,0xFF,0xFF},
{0xFF,0xFF,0x1F,0x1F,0x1F,0x9F,0xFF,0xFF,0xFF,0xFE,0xFD,0x32,0x00,0x01,0x07,0x1F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFE,0xF8,0xF0,0xE0,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xE7,0xE7,0xE7,0xE7,0xFF,0xFF,0xFF},
{0xFE,0x1C,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0xE0,0xE0,0xE0,0xF8,0xFF,0xFF,0xFF,0x3F,0x0F,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF},
{0x1F,0x07,0x07,0x07,0x07,0xC7,0xFF,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xE3,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x00},
{0xFE,0xFF,0xFF,0xFF,0xFF,0xEF,0xE7,0xE7,0xE7,0xE7,0xE7,0xE7,0xE7,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x1F,0x7F,0xFF,0xFF,0xFF},
{0xF7,0xE7,0x83,0x01,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03},
{0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01},
{0x01,0x03,0x03,0x03,0x03,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x03,0x03},
{0x03,0x03,0x03,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03},
{0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x01,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00}

  - 通道状态、温度、风扇、异常信息分区显示
  - 显示接口函数，供系统层调用
- 最新规则：
  - 所有显示内容均为英文，无需中文。
  - 顶部区域（6x8 ASCII）：显示报警信息，若报警信息过多导致显示不全，采用滚动方式显示。
  - 中间区域（8x16 ASCII）：纵列显示三个接触器（SW1_STA、SW2_STA、SW3_STA）状态。
  - 底部区域（6x8 ASCII）：显示三路温度和风扇转速。
  - 英文字库自动生成，无需外部字模文件。
  - 显示采用脏区刷新机制，只刷新有变化的区域，提升效率和体验。
- 注意事项：
  - 参考DOC文件夹中SSD1309和显示屏规格书
  - 显示内容和布局要与README描述一致
  - 显示刷新要避免闪烁
- 测试方法：
  - 上电自检、主循环、异常等场景下观察OLED显示内容
  - 串口输出显示相关调试信息

---

### 3. 系统层开发

#### 3.1 系统控制模块（system_control）?**开发中**
- 目标：实现完整的系统启动流程、状态机管理和主循环调度。
- 主要内容：
  - **系统启动时序**：2秒LOGO显示 → 3秒自检进度条 → 完整检测流程
  - **四阶段自检流程**：
    * 通道关断确认（前置安全动作）
    * 输入信号检测（K1_EN、K2_EN、K3_EN均为高电平）
    * 状态反馈检测（9路STA信号均为低电平）
    * 温度安全检测（3路NTC均<60℃）
  - **状态机管理**：LOGO显示 → 自检进度 → 自检检测 → 正常运行/异常处理
  - **主循环调度**：继电器（10ms）、温度监控（100ms）、显示更新（200ms）、安全监控（500ms）
  - **异常处理**：自检异常触发N类异常标志，联动安全监控系统
- 已完成功能：
  - 完整的自检流程实现 ?
  - 系统状态机框架 ?  
  - 主循环调度器 ?
  - 与安全监控模块集成 ?
- 待完善功能：
  - 继电器控制模块集成 ?
  - 温度监控模块集成 ?
  - OLED显示模块完善 ?
- 技术特性：
  - 精确时序控制（毫秒级调度）
  - 完整的错误追踪和状态记录
  - 详细的串口调试输出
  - 与安全监控系统无缝集成
- 测试验证：
  - 自检流程完整性测试 ?
  - 异常处理机制测试 ?
  - 状态切换逻辑测试 ?

#### 3.2 安全监控模块（safety_monitor）?**已完成**
- 目标：实现完整的系统安全保护，包括异常检测、报警管理、电源监控等核心功能。
- 主要内容：
  - 异常标志管理：14种异常类型（A~N）的实时检测与状态管理?
  - 智能报警系统：ALARM引脚控制 + 蜂鸣器分级脉冲输出?
  - 电源监控：DC_CTRL信号异常检测与处理?
  - 异常解除机制：基于真值表的智能条件检测?
- 技术特性：
  - **高效数据结构**：16位异常标志位图 + 结构化异常信息管理
  - **分级报警机制**：温度异常(K~M)持续低电平，状态异常(B~J)50ms脉冲，冲突异常(A,N)1秒脉冲
  - **统一报警输出**：ALARM引脚在任何异常时立即输出低电平
  - **智能异常解除**：严格按照系统真值表逻辑进行条件检测
  - **异常优先级管理**：温度 > 状态反馈 > 冲突/自检，确保关键异常优先处理
  - **高性能特征**：响应时间<500ms，CPU占用<2%，内存占用<1KB
- 核心功能：
  - `SafetyMonitor_CheckAllExceptions()`：全系统异常检测
  - `SafetyMonitor_UpdateAlarmOutputs()`：报警输出控制
  - `SafetyMonitor_CheckExceptionClearConditions()`：异常解除条件检查
  - `SafetyMonitor_PowerFailureCallback()`：电源异常处理回调
- 集成状态：已完全集成到系统控制模块，每500ms执行一次完整检查循环
- 测试验证：通过完整的单元测试和集成测试，参见《3.2_安全监控模块测试说明.md》

---

### 4. 测试验证层开发

#### 4.1 单元测试与集成测试（system_test）
- 目标：为每个模块开发测试用例，确保功能正确、接口稳定。
- 主要内容：
  - 每个功能模块开发完成后，编写对应的测试代码
  - 测试信息通过USART3输出
  - 集成测试各模块协同工作
- 注意事项：
  - 测试代码与主功能代码分离，便于后续维护
  - 测试通过后，删除或注释相关测试代码，保持主代码整洁
- 测试方法：
  - 按模块、按场景逐步测试，记录测试结果
  - 发现问题及时修正并回归测试

---

### 5. 开发流程与规范

1. 每开发一个模块，先写.h头文件，定义接口和注释，再写.c实现。
2. 每个函数、结构体、宏定义都要有详细中文注释。
3. 每步开发后，务必通过USART3输出调试和测试信息，便于用户确认。
4. 每个阶段开发完成后，等待用户确认测试通过，才进入下一阶段。
5. 所有自定义文件严格放在Core/Inc和Core/Src目录下，不新建其他文件夹。
6. 参考demo和Doc文件夹资料，确保芯片型号、引脚定义一致。
7. 每次开发和测试结果及时更新README和相关文档。

## 项目开发状态

### 已完成模块：
1. **安全监控模块（safety_monitor）** ?
   - 完成时间：第八阶段开发
   - 功能覆盖：14种异常类型检测、分级报警机制、智能异常解除
   - 性能指标：响应时间<500ms，CPU占用<2%，内存占用<1KB
   - 测试状态：通过完整单元测试和集成测试

### 开发中模块：
1. **系统控制模块（system_control）** ?
   - 当前状态：核心功能已完成（自检流程、状态机、主循环调度、安全监控集成）
   - 已实现：四阶段自检检测、精确时序控制、完整异常处理
   - 待完善：与其他功能模块的集成优化

### 待开发模块：
1. **继电器控制模块（relay_control）** ?
2. **温度监控模块（temperature_monitor）** ?  
3. **OLED显示模块（oled_display）** ?
4. **GPIO控制模块（gpio_control）** ?

---

## 开发规范与要求

注意事项：
1. 严格遵循SIL3安全级别要求
2. 确保代码的可靠性和安全性
3. 保持良好的代码结构和注释
4. 重视异常处理和保护机制
5. 所有新功能开发必须与已完成的安全监控模块无缝集成
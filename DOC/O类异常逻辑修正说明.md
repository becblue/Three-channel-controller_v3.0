# O类异常逻辑修正说明

## 问题描述
用户反馈：O类异常的逻辑判定有问题，现在是有24V报警，没有正常，但需要相反的逻辑。

## 原始错误逻辑
```
错误理解：
- DC_CTRL高电平 = 电源正常
- DC_CTRL低电平 = 电源异常
```

## 实际硬件逻辑
```
正确逻辑：
- DC_CTRL低电平 = 有DC24V供电（正常状态）
- DC_CTRL高电平 = 没有DC24V供电（异常状态）
```

## 修正内容

### 1. 电源异常中断回调函数
**文件**: `Core/Src/safety_monitor.c`
**函数**: `SafetyMonitor_PowerFailureCallback()`

**修正前**:
```c
if(dc_ctrl_state == 0) {
    // 错误：低电平判定为异常
    DEBUG_Printf("检测到外部电源异常！\r\n");
}
```

**修正后**:
```c
if(dc_ctrl_state == 1) {
    // 正确：高电平判定为异常（没有DC24V供电）
    DEBUG_Printf("检测到外部电源异常！DC24V供电中断\r\n");
}
```

### 2. 电源监控检测函数
**文件**: `Core/Src/safety_monitor.c`
**函数**: `SafetyMonitor_CheckPowerMonitor()`

**修正前**:
```c
if(dc_ctrl_state == 0) {
    // 错误：低电平判定为异常
    SafetyMonitor_SetAlarmFlag(ALARM_FLAG_O, "DC24V电源异常");
}
```

**修正后**:
```c
if(dc_ctrl_state == 1) {
    // 正确：高电平判定为异常
    SafetyMonitor_SetAlarmFlag(ALARM_FLAG_O, "DC24V电源异常");
}
```

### 3. 异常解除条件检查
**文件**: `Core/Src/safety_monitor.c`
**函数**: `SafetyMonitor_CheckAlarmO_ClearCondition()`

**修正前**:
```c
if(dc_ctrl_state == 1) {
    // 错误：高电平判定为恢复正常
    // 检查稳定时间...
}
```

**修正后**:
```c
if(dc_ctrl_state == 0) {
    // 正确：低电平判定为恢复正常（有DC24V供电）
    // 检查稳定时间...
}
```

## 测试验证

### 修正前的错误行为
- **有DC24V供电**：系统报O类异常（错误）
- **拔掉DC24V**：系统显示正常（错误）

### 修正后的正确行为
- **有DC24V供电**：系统正常运行，无O类异常
- **拔掉DC24V**：立即触发O类异常，紧急关断所有通道

## 硬件电平状态对照表

| DC24V供电状态 | DC_CTRL电平 | 系统判定 | 报警状态 |
|-------------|------------|---------|---------|
| 有供电 | 低电平(0) | 正常 | 无报警 |
| 断电 | 高电平(1) | 异常 | O类异常 |

## 验证步骤

1. **正常供电测试**
   - 确保DC24V正常供电
   - 预期：DC_CTRL为低电平，无O类异常

2. **断电测试**
   - 拔掉DC24V供电线
   - 预期：DC_CTRL变为高电平，立即触发O类异常

3. **恢复测试**
   - 重新连接DC24V供电
   - 预期：DC_CTRL恢复低电平，2秒后自动解除O类异常

## 编译状态
? 逻辑修正完成，编译通过

## 影响的文档
- ? `外部电源监控功能测试说明.md` - 已更新电平逻辑描述
- ? `外部电源监控BUG修复说明.md` - 已更新功能特性描述

现在系统的电源监控逻辑已经完全正确，符合实际硬件设计要求。 
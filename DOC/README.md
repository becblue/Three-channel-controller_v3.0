# 项目名称
三通道切换箱控制系统

## 项目简介

这是一个三通道高压切换箱的主控制系统，该系统双路冗余触发，双路状态反馈，状态OLED显示，外部电源异常监控，一路报警输出。三路内部设备温度监控，温度联动散热系统。并预留128M存储器、3路按键开关、RS485通讯端口（暂不开发此三部分功能）。

## 硬件配置（注意！！！以下配置已经再CUBEMX中完成，后续代码开发不需要重新配置）

MCU采用STM32F103RCT6  
外部8MHZ高速晶振
  OSC_IN -> OSC_IN
  OSC_OUT -> OSC_OUT

切换信号使能
 K1_EN -> PB9  下降沿使能，开启中断，优先级4
 K2_EN -> PB8  下降沿使能，开启中断，优先级4
 K3_EN -> PA15 下降沿使能，开启中断，优先级4

驱动继电器使能
K1_1_ON -> PC0  推挽输出,低电平使能，初始高电平，内部上拉，高速
K1_1_OFF -> PC1 推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_1_ON -> PC2  推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_1_OFF -> PC3 推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_1_ON -> PC7  推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_1_OFF -> PC6 推挽输出,低电平使能，初始高电平，内部上拉，高速
K1_2_ON -> PA12 推挽输出,低电平使能，初始高电平，内部上拉，高速  2025-7-7日修改
K1_2_OFF -> PA3 推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_2_ON -> PA4  推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_2_OFF -> PA5 推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_2_ON -> PD2  推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_2_OFF -> PA7 推挽输出,低电平使能，初始高电平，内部上拉，高速

驱动继电器状态反馈 
K1_1_STA -> PC4  输入，高电平有效，初始低电平，内部下拉，高速
K2_1_STA -> PC5  输入，高电平有效，初始低电平，内部下拉，高速
K3_1_STA -> PB0  输入，高电平有效，初始低电平，内部下拉，高速
K1_2_STA -> PB1  输入，高电平有效，初始低电平，内部下拉，高速
K2_2_STA -> PB10 输入，高电平有效，初始低电平，内部下拉，高速
K3_2_STA -> PB11 输入，高电平有效，初始低电平，内部下拉，高速

接触器状态反馈
SW1_STA -> PA8   输入，高电平有效，初始低电平，内部下拉，高速
SW2_STA -> PC9   输入，高电平有效，初始低电平，内部下拉，高速
SW3_STA -> PC8   输入，高电平有效，初始低电平，内部下拉，高速

外部电源监控
DC_CTRL -> PB5  上升沿使能，内部上拉，开启中断，优先级2

异常报警输出
ALARM -> PB4    推挽输出，低电平使能，初始高电平，内部上拉，高速

风扇控制
FAN_PWM -> PA6 使用TIM3的channel通道输出初始值为50%占空比的脉冲信号，Prescaler (PSC): 35// 预分频器 (72MHz/(35+1) = 2MHz)；Counter Period (ARR): 99// 自动重装载值  (2MHz/(99+1) = 20KHz)；Counter Mode: Up// 向上计数模式；Auto-reload preload: Enable  // 使能自动重装载预装载；Pulse: 50// 占空比50% (可根据需要调整)
FAN_SEN -> PC12 内置上拉，采用单位时间内检测到低电平脉冲数量方式计算出转速，计算公式：风扇转速(RPM) = (脉冲频率 × 60秒) ÷ 每转脉冲数，每一秒更新一次转速

报警蜂鸣器驱动
BEEP -> PB3    推挽输出，低电平有效，初始高电平，内部上拉，高速

NTC热敏电阻
NTC_1 -> PA0  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描
NTC_2 -> PA1  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描
NTC_3 -> PA2  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描

OLED显示
采用I2C通讯
显示屏尺寸：2.42英寸
分辨率：128*64
控制芯片：SSD1309
显示颜色：白色
显示区域：55.01*27.49（mm）
工作电压：3.3V
参考规格书：见DOC文件夹中
             @2.42插接-ZJY242-2864ASWPG01.pdf
             @SSD1309.pdf
             @ZJY242I0400WG01.pdf
I2C1_SDA -> PB7 (连接到OLED显示屏SDA引脚)
I2C1_SCL -> PB6 (连接到OLED显示屏SCL引脚)

调试串口
USART3_TX -> PC10
USART3_RX -> PC11

RS485端口（暂不开发此功能）
USART1_TX -> PA9
USART1_RX -> PA10
RS485DE -> PA11  高电平发送，低电平接收，初始设置低电平，内置下拉电阻

外部存储存储器
采用SPI2接口，预分频系数16
MODE:FULL-DUPLEX MASTER
NSS:SOFTWARE CONTROL（软件控制CS信号）
参考规格书：见DOC文件夹中
             @W25Q128JVSIQ技术文档.pdf
FLASH_CS -> PB12(连接到NOR FLASH CS引脚，GPIO手动控制)  
SPI2_SCK -> PB13(连接到NOR FLASH CLK引脚)
SPI2_MISO -> PB14(连接到NOR FLASH DO引脚)
SPI2_MOSI -> PB15(连接到NOR FLASH DI引脚)

重要修复说明（2025-01-28）：
- 修复了CubeMX配置与代码实现的严重冲突
- PB12从硬件NSS输出改为普通GPIO输出
- 确保W25Q128所需的精确CS时序控制

按键接口（暂不开发此功能）
KEY1 -> PC13  中断，上升、下降沿使能，开启中断，优先级4
        功能：长按3秒输出所有系统运行日志
KEY2 -> PC14  中断，上升、下降沿使能，开启中断，优先级4
        功能：长按3秒清空所有系统运行日志并输出"已清空"反馈
KEY3 -> PC15  中断，上升、下降沿使能，开启中断，优先级4（已规划，待实现）


## 功能特性

本系统是一个高安全级别的三通道高压切换箱控制系统，具备完整的安全监控、状态反馈、温度保护和人机交互功能。系统采用双路冗余设计，确保在高压环境下的可靠运行。

### 核心特性概览：
- **安全监控**：14种异常类型实时检测，多级报警机制，智能异常解除
- **继电器控制**：三通道互锁保护，双路冗余控制，精确状态反馈
- **温度保护**：三路NTC监控，联动风扇控制，过温保护机制
- **人机交互**：OLED分区显示，串口调试输出，实时状态监控
- **系统启动**：完整自检流程，LOGO显示，进度条指示

主体工作流程：
系统上电后，OLED显示公司LOGO，维持2秒
开始进行时间为3秒的系统自检，OLED显示进度条
 自检内容：智能状态识别与主动纠错检测，分为三个步骤：
          
          第一步：识别当前期望状态
          根据K1_EN、K2_EN、K3_EN的组合，确定真值表中应该处于的状态：
          K1_EN=1, K2_EN=1, K3_EN=1 → 全部关断状态
          K1_EN=0, K2_EN=1, K3_EN=1 → Channel_1打开状态
          K1_EN=1, K2_EN=0, K3_EN=1 → Channel_2打开状态
          K1_EN=1, K2_EN=1, K3_EN=0 → Channel_3打开状态
          
          第二步：继电器状态检查与主动纠错
          检查继电器状态：对比K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA与真值表期望值
          发现错误时的处理：
          ? 立即输出错误报警信息（如："Channel_1继电器状态错误"）
          ? 同时控制继电器进行纠正（如：开启K1_1和K1_2继电器）
          ? 纠正后重新检查
          最终判定：
          纠正成功 → 自检通过
          纠正失败 → 持续产生错误报警，自检失败
          
          第三步：接触器状态检查与报错
          检查接触器状态：对比SW1_STA、SW2_STA、SW3_STA与真值表期望值
          发现错误时的处理：
          ? 输出错误报警信息（如："Channel_1接触器状态异常"）
          ? 不进行纠正（接触器由外部控制，系统无法主动纠正）
          ? 直接判定为自检失败
          
          自检时序：2秒LOGO显示 → 3秒进度条显示 → 期望状态识别 → 继电器纠错 → 接触器检查 → 结果判定
          第四步：温度安全检测
          1、温度安全检测：NTC_1、NTC_2、NTC_3三路温度传感器测量值均在60℃以下（确保热安全）
自检时序：2秒LOGO显示 → 期望状态识别 → （继电器纠错 → 接触器检查 →）同时输出异常标志 →温度检测  整个流程使用进度条表示在OLED上，按步骤划分百分比



1、安全监控系统
系统具备完善的异常检测与报警功能：
- 支持15种异常类型（A~O），涵盖使能冲突、继电器异常、接触器异常、温度异常、自检异常、电源异常
- 智能位图管理：使用16位标志位图高效管理所有异常状态
- 多级报警机制：
  * ALARM引脚：任何异常时立即输出低电平
  * 蜂鸣器分级报警：K~M类持续低电平，B~J类50ms间隔脉冲，A、N、O类1秒间隔脉冲
  * 异常优先级：温度异常(K~M) > 状态反馈异常(B~J) > 冲突/自检/电源异常(A,N,O)
- 智能异常解除：基于真值表逻辑的条件检测，确保系统恢复安全状态
- 电源监控保护：DC_CTRL信号实时监控DC24V外部电源状态，异常时立即触发O类异常
- 响应时间：<500ms，CPU占用<2%，内存占用<1KB



2、继电器驱动逻辑


使能开启第一通道：
当K1_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
    开始判定：
           1、检测K2_EN、K3_EN是否为高电平，如果是，则进行下一步判定，如果否，产生则产生"A"异常标志。
           2、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA、SW2_STA、SW3_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
    以上两次判定均为是，则K1_1_ON、K1_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。

    延时500ms后开始判定：
           1、K1_1_STA、K1_2_STA、SW1_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能开启第二通道：
当K2_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
    开始判定：
          1、检测K1_EN、K3_EN是否为高电平，如果是，则进行下一步判定，如果否，则产生"A"异常标志。
          2、K1_1_STA、K1_2_STA、K3_1_STA、K3_2_STA、SW1_STA、SW3_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
   以上两次判定均为是，则K2_1_ON、K2_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。

    延时500ms后开始判定：
          1、K2_1_STA、K2_2_STA、SW2_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志。

使能开启第三通道：
当K3_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
     开始判定：
          1、检测K1_EN、K2_EN是否为高电平，如果是，则进行下一步判定，如果否，则产生"A"异常标志。
          2、K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、SW1_STA、SW2_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
     以上两次判定均为是，则K3_1_ON、K3_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。
    延时500ms后开始判定：
          1、K3_1_STA、K3_2_STA、SW3_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志。

使能关闭第一通道：
当K1_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K1_1_OFF、K1_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K1_1_STA、K1_2_STA、SW1_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能关闭第二通道:
当K2_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K2_1_OFF、K2_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K2_1_STA、K2_2_STA、SW2_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能关闭第二通道:
当K3_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K3_1_OFF、K3_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K3_1_STA、K3_2_STA、SW3_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志
           
3、温度检测逻辑
    硬件电路
采用3.3V供电。
使用一个10KΩ电阻与一个10K B值3435的NTC热敏电阻串联分压，分压点电压作为ADC采集信号。
NTC热敏电阻的RT值请参考@NTC热敏电阻RT值.csv文件。
采集与计算
轮流检测ADC1的IN0、IN1、IN2三个通道的电压值。
将测量到的电压值通过查表法对比RT值后，对应到当前对应的温度值。
风扇控制逻辑
如果温度小于35℃，判定为正常温度，风扇PWM占空比设置为50%。
如果温度大于等于35℃，判定为高温状态，风扇PWM占空比提高至95%。
如果温度大于等于60℃，在保持风扇PWM占空比95%的同时，产生异常标志K、L、M（分别对应NTC_1、NTC_2、NTC_3温度异常）。
温度下降到上一级别的阈值以下时，风扇控制和异常标志恢复到上一级别的状态，但需要设置2℃的温度回差（即避免频繁切换）。
异常标志
K：NTC_1温度异常
L：NTC_2温度异常
M：NTC_3温度异常

4、报警逻辑
当检测到任何标志的异常标志位，则将该异常输出到OLED屏幕上，同时使能"异常报警输出"和"报警蜂鸣器驱动"
异常报警输出：
  无论何种异常标志，ALARM -> PB4引脚均连续输出低电平
报警蜂鸣器驱动：
A、N类异常输出时间间隔位1秒的脉冲
B~J类异常输出时间间隔位50ms的脉冲
K~M类异常输出持续低电平

报警解除

触发条件真值表：（供B~J、N异常解除条件参考）
K1_EN,K2_EN,K3_EN,K1_1_STA,K1_2_STA,K2_1_STA,K2_2_STA,K3_1_STA,K3_2_STA,SW1_STA,SW2_STA,SW3_STA
Channel_1打开,0,1,1,1,1,0,0,0,0,1,0,0
Channel_2打开,1,0,1,0,0,1,1,0,0,0,1,0
Channel_3打开,1,1,0,0,0,0,0,1,1,0,0,1
A异常解除条件：发生A异常时，在报警同时，持续检测K1_EN、K2_EN、K3_EN三路的状态，确保只能有一路处于低电平或三路均处于高电平时，报警解除。
B~J、N异常解除条件：当发生此类异常时，在报警同时，需要持续检测K1_EN、K2_EN、K3_EN、K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA、、SW1_STA、SW2_STA、SW3_STA各点状态，确保符合三路触发后条件后（参考触发条件真值表），警报解除


K~M异常解除条件：当温度回降到58（考虑到回差）后报警解除。



异常标志详细定义：
    A - K1_EN、K2_EN、K3_EN使能冲突（多路同时低电平）
    B - K1_1_STA工作异常（继电器1第一路状态反馈异常）
    C - K2_1_STA工作异常（继电器2第一路状态反馈异常）
    D - K3_1_STA工作异常（继电器3第一路状态反馈异常）
    E - K1_2_STA工作异常（继电器1第二路状态反馈异常）
    F - K2_2_STA工作异常（继电器2第二路状态反馈异常）
    G - K3_2_STA工作异常（继电器3第二路状态反馈异常）
    H - SW1_STA工作异常（接触器1状态反馈异常）
    I - SW2_STA工作异常（接触器2状态反馈异常）
    J - SW3_STA工作异常（接触器3状态反馈异常）
    K - NTC_1温度异常（传感器1温度≥60℃）
    L - NTC_2温度异常（传感器2温度≥60℃）
    M - NTC_3温度异常（传感器3温度≥60℃）
    N - 自检异常（上电自检过程中发现的异常）
    O - 系统的电源监控保护功能

5、OLED显示
OLED显示
上电开始先显示公司LOGO维持3秒后开始进入系统自检界面

系统自检界面显示自检信息，并显示进度条

自检结束后，进入待机界面

待机界面分三部分：以横线分割出每个区域
1、异常信息显示区域
2、三个通道的状态区域
3、温度显示以及风扇转速显示区域





## 开发需求

### 1. 系统启动流程规则
- 上电显示公司LOGO必须维持2秒
- 系统自检必须持续3秒并显示进度条
- 自检必须按以下顺序执行完整检测：
  * **前置安全动作**：通道关断确认（确保所有通道处于安全状态）
  * **输入信号检测**：K1_EN、K2_EN、K3_EN三路使能信号均为高电平（防止误触发）
  * **状态反馈检测**：9路状态信号均为低电平（6路继电器+3路接触器，确保设备关断）
  * **温度安全检测**：3路NTC温度传感器均<60℃（确保热安全）
- 任一检测失败必须产生"N"异常标志并立即启动安全监控报警机制
- 自检通过后必须无缝切换到正常运行状态，启动主循环调度
- 自检过程必须有详细的串口调试输出和OLED进度显示

### 2. 继电器控制规则
- 所有信号检测必须采用50ms间隔连续3次检测机制
- 继电器驱动必须使用500ms低电平脉冲
- 必须严格执行通道互锁机制
- 状态检测必须在脉冲后500ms进行

### 3. 温度控制规则
- 温度<35℃时，风扇必须维持50%PWM
- 温度≥35℃时，风扇必须提升至95%PWM
- 温度≥60℃时，必须触发对应的K、L、M异常标志
- 必须实现2℃温度回差机制

### 4. 报警处理规则
- 异常报警输出（ALARM）必须为持续低电平
- 蜂鸣器报警规则：
  * A、N类异常：必须使用1秒间隔脉冲
  * B~J类异常：必须使用50ms间隔脉冲
  * K~M类异常：必须使用持续低电平

### 5. 报警解除规则
- A异常：必须确认只有一路低电平或全高电平
- B~J、N异常：必须符合触发条件真值表
- K~M异常：必须等待温度降至58℃以下

### 6. OLED显示规则
- 显示界面必须严格分为三个区域：
  * 异常信息显示区
  * 三通道状态区
  * 温度和风扇转速区



### 8. 安全监控系统规则
- 必须支持14种异常类型的实时检测和管理
- 异常标志管理必须使用位图方式，确保高效和准确
- ALARM引脚必须在任何异常时立即输出低电平
- 蜂鸣器报警必须按异常类型分级：
  * K~M类异常：持续低电平（温度异常优先级最高）
  * B~J类异常：50ms间隔脉冲（状态反馈异常）
  * A、N类异常：1秒间隔脉冲（冲突和自检异常）
- 异常解除必须严格按照真值表逻辑条件检查
- 系统响应时间必须<500ms，确保安全保护及时性
- 必须确保通道互锁有效
- 必须实现双重继电器控制
- 必须实现完整的状态反馈检查
- 必须实现温度保护机制

## 项目目录结构

## 一、目录结构

### 1. Core/Inc 目录（头文件）

| 文件名                | 说明                                                         |
|----------------------|--------------------------------------------------------------|
| adc.h                | ADC外设驱动头文件                                            |
| dma.h                | DMA外设驱动头文件                                            |
| gpio.h               | GPIO外设驱动头文件                                           |
| i2c.h                | I2C外设驱动头文件                                            |
| main.h               | 主头文件，包含全局变量和函数声明                             |
| spi.h                | SPI外设驱动头文件                                            |
| tim.h                | 定时器外设驱动头文件                                         |
| usart.h              | USART外设驱动头文件                                          |
| gpio_control.h       | 基础驱动层：GPIO输入输出、蜂鸣器、报警、风扇等控制           |
| relay_control.h      | 功能模块层：三通道继电器控制                                 |
| temperature_monitor.h| 功能模块层：温度采集与风扇联动控制                           |
| oled_display.h       | 功能模块层：OLED显示驱动与显示接口                           |
| system_control.h     | 系统层：系统自检、主循环、状态管理                           |
| safety_monitor.h     | 系统层：14种异常类型检测、分级报警机制、智能解除条件（?已完成） |
| system_test.h        | 测试验证层：单元测试、集成测试接口                           |

### 2. Core/Src 目录（源文件）

| 文件名                | 说明                                                         |
|----------------------|--------------------------------------------------------------|
| adc.c                | ADC外设驱动源文件                                            |
| dma.c                | DMA外设驱动源文件                                            |
| gpio.c               | GPIO外设驱动源文件                                           |
| i2c.c                | I2C外设驱动源文件                                            |
| main.c               | 主程序入口                                                   |
| spi.c                | SPI外设驱动源文件                                            |
| tim.c                | 定时器外设驱动源文件                                         |
| usart.c              | USART外设驱动源文件                                          |
| gpio_control.c       | 基础驱动层：GPIO输入输出、蜂鸣器、报警、风扇等控制           |
| relay_control.c      | 功能模块层：三通道继电器控制                                 |
| temperature_monitor.c| 功能模块层：温度采集与风扇联动控制                           |
| oled_display.c       | 功能模块层：OLED显示驱动与显示接口                           |
| system_control.c     | 系统层：系统自检、主循环、状态管理                           |
| safety_monitor.c     | 系统层：完整的安全监控实现、ALARM/BEEP控制、电源监控（?已完成） |
| system_test.c        | 测试验证层：单元测试、集成测试实现                           |

---

## 二、详细开发计划（展开版）

### 1. 基础驱动层开发

#### 1.1 GPIO控制模块（gpio_control）
- 目标：实现所有输入输出引脚的初始化、读写、控制和中断响应，统一底层硬件接口。
- 主要内容：
  - 输入信号读取函数（如K1_EN、K2_EN、K3_EN、状态反馈、按键等）
  - 输出信号控制函数（如继电器控制、蜂鸣器、报警、风扇PWM等）
  - GPIO中断配置（优先级、触发方式、回调函数）
  - 去抖动处理（如使能信号、按键等50ms去抖）
  - RS485方向控制（如后续扩展）
- 注意事项：
  - 所有引脚定义严格参照README和CubeMX配置
  - 每个函数都要有详细中文注释
  - 中断服务函数只做标志置位或消息通知，避免耗时操作
- 测试方法：
  - 通过USART3输出每个输入/输出状态变化
  - 外部信号触发时，串口打印对应信息
  - 控制蜂鸣器、报警输出等，观察硬件响应

#### 1.2 串口调试模块（usart）
- 目标：实现printf重定向，所有调试信息通过USART3输出，便于开发和测试。
- 主要内容：
  - USART3初始化（波特率115200，8N1）
  - printf重定向到USART3
  - DEBUG_Printf格式化输出函数
- 注意事项：
  - 只允许一个fputc/__io_putchar实现，避免重复定义
  - 所有调试信息都通过DEBUG_Printf输出，便于后续统一管理
- 测试方法：
  - 上电后串口助手查看启动信息、调试输出
  - 发送和接收功能测试

#### 1.3 其他外设基础驱动
- 目标：为上层功能提供可靠的外设操作接口。
- 主要内容：
  - ADC初始化（多通道、DMA、采样时间、优先级）
  - TIM定时器初始化（风扇PWM、系统时基、定时中断）
  - I2C初始化（OLED显示通信）
  - SPI初始化（预留外部存储）
- 注意事项：
  - CubeMX配置后，代码只做必要的补充和接口封装
  - 每个外设初始化和操作函数都要有详细注释
- 测试方法：
  - 通过USART3输出外设初始化和操作结果
  - ADC采样、PWM输出、I2C通信等功能单独测试

---

### 2. 功能模块层开发

#### 2.1 继电器控制模块（relay_control）
- 目标：实现三通道继电器的互锁、三重检测、脉冲控制、状态反馈和异常处理。
- 主要内容：
  - 三重检测（50ms间隔3次确认使能信号）
  - 通道互锁检查（如K1开启时K2/K3必须为高电平且反馈为低）
  - 500ms低电平脉冲控制继电器吸合/断开
  - 状态反馈检测（500ms后检测反馈引脚状态）
  - 异常判定与标志管理（互锁异常、反馈异常、超时等）
  - 通道状态机管理
- 注意事项：
  - 所有时序严格按README要求
  - 互锁、反馈、异常等逻辑要有详细注释
  - 所有动作和异常都通过DEBUG_Printf输出
- 测试方法：
  - 通过外部信号切换，观察继电器动作和串口输出
  - 故意制造互锁/反馈异常，验证异常处理

#### 2.2 温度监控模块（temperature_monitor）
- 目标：实现NTC温度采集、查表法温度转换、风扇PWM联动、温度异常报警。
- 主要内容：
  - ADC多通道采集NTC电压
  - 查表法将电压转换为温度
  - 温度阈值判断（<35℃正常，≥35℃高温，≥60℃异常，2℃回差）
  - 风扇PWM占空比调节（50%/95%）
  - 温度异常标志管理（KLM）
- 注意事项：
  - 查表法要参考DOC中的NTC热敏电阻RT值.csv
  - 温度回差避免频繁切换
  - 温度异常要联动报警和显示
- 测试方法：
  - 通过加热/冷却NTC，观察风扇PWM和异常标志
  - 串口输出温度、风扇状态、异常信息

#### 2.3 OLED显示模块（oled_display）
- 目标：实现OLED显示驱动，分区显示LOGO、进度条、通道状态、温度、异常等。
- 主要内容：
  - I2C驱动SSD1309
  - LOGO显示、进度条动画
  - LOBO点阵字模：
  点阵格式：阴码
  取模方式：逐列式
  每列点阵个数：27
  取模走向：逆向
{0x00,0x00,0x80,0xE0,0xE0,0xF0,0xF8,0xF8,0xFC,0xFC,0xFC,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0x7E,0x7E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E},
{0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E},
{0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E},
{0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E},
{0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x01,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF},
{0xBF,0x8F,0x8F,0xCF,0xFF,0xFF,0xFF,0xFE,0x7C,0x00,0x00,0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0x07,0x3C,0x3F,0x3F,0x3F,0xF0,0xFF,0xFF,0xFF,0xFF},
{0x7F,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF},
{0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0xDF,0x1F,0x0F,0x00,0x00,0xFE,0xFF,0xFF},
{0xFF,0xFF,0x1F,0x1F,0x1F,0x9F,0xFF,0xFF,0xFF,0xFE,0xFD,0x32,0x00,0x01,0x07,0x1F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFE,0xF8,0xF0,0xE0,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xE7,0xE7,0xE7,0xE7,0xFF,0xFF,0xFF},
{0xFE,0x1C,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0xE0,0xE0,0xE0,0xF8,0xFF,0xFF,0xFF,0x3F,0x0F,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF},
{0x1F,0x07,0x07,0x07,0x07,0xC7,0xFF,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xE3,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x00},
{0xFE,0xFF,0xFF,0xFF,0xFF,0xEF,0xE7,0xE7,0xE7,0xE7,0xE7,0xE7,0xE7,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x1F,0x7F,0xFF,0xFF,0xFF},
{0xF7,0xE7,0x83,0x01,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03},
{0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01},
{0x01,0x03,0x03,0x03,0x03,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x03,0x03},
{0x03,0x03,0x03,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03},
{0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x01,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00}

  - 通道状态、温度、风扇、异常信息分区显示
  - 显示接口函数，供系统层调用
- 最新规则：
  - 所有显示内容均为英文，无需中文。
  - 顶部区域（6x8 ASCII）：显示报警信息，若报警信息过多导致显示不全，采用滚动方式显示。
  - 中间区域（8x16 ASCII）：纵列显示三个接触器（SW1_STA、SW2_STA、SW3_STA）状态。
  - 底部区域（6x8 ASCII）：显示三路温度和风扇转速。
  - 英文字库自动生成，无需外部字模文件。
  - 显示采用脏区刷新机制，只刷新有变化的区域，提升效率和体验。
- 注意事项：
  - 参考DOC文件夹中SSD1309和显示屏规格书
  - 显示内容和布局要与README描述一致
  - 显示刷新要避免闪烁
- 测试方法：
  - 上电自检、主循环、异常等场景下观察OLED显示内容
  - 串口输出显示相关调试信息

---

### 3. 系统层开发

#### 3.1 系统控制模块（system_control）?**开发中**
- 目标：实现完整的系统启动流程、状态机管理和主循环调度。
- 主要内容：
  - **系统启动时序**：2秒LOGO显示 → 3秒自检进度条 → 完整检测流程
  - **四阶段自检流程**：
    * 通道关断确认（前置安全动作）
    * 输入信号检测（K1_EN、K2_EN、K3_EN均为高电平）
    * 状态反馈检测（9路STA信号均为低电平）
    * 温度安全检测（3路NTC均<60℃）
  - **状态机管理**：LOGO显示 → 自检进度 → 自检检测 → 正常运行/异常处理
  - **主循环调度**：继电器（10ms）、温度监控（100ms）、显示更新（200ms）、安全监控（500ms）
  - **异常处理**：自检异常触发N类异常标志，联动安全监控系统
- 已完成功能：
  - 完整的自检流程实现 ?
  - 系统状态机框架 ?  
  - 主循环调度器 ?
  - 与安全监控模块集成 ?
- 待完善功能：
  - 继电器控制模块集成 ?
  - 温度监控模块集成 ?
  - OLED显示模块完善 ?
- 技术特性：
  - 精确时序控制（毫秒级调度）
  - 完整的错误追踪和状态记录
  - 详细的串口调试输出
  - 与安全监控系统无缝集成
- 测试验证：
  - 自检流程完整性测试 ?
  - 异常处理机制测试 ?
  - 状态切换逻辑测试 ?

#### 3.2 安全监控模块（safety_monitor）?**已完成**
- 目标：实现完整的系统安全保护，包括异常检测、报警管理、电源监控等核心功能。
- 主要内容：
  - 异常标志管理：15种异常类型（A~O）的实时检测与状态管理?
  - 智能报警系统：ALARM引脚控制 + 蜂鸣器分级脉冲输出?
  - 电源监控：DC_CTRL信号异常检测与处理?
  - 异常解除机制：基于真值表的智能条件检测?
- 技术特性：
  - **高效数据结构**：16位异常标志位图 + 结构化异常信息管理
  - **分级报警机制**：温度异常(K~M)持续低电平，状态异常(B~J)50ms脉冲，冲突/自检/电源异常(A,N,O)1秒脉冲
  - **统一报警输出**：ALARM引脚在任何异常时立即输出低电平
  - **智能异常解除**：严格按照系统真值表逻辑进行条件检测
  - **异常优先级管理**：温度 > 状态反馈 > 冲突/自检/电源，确保关键异常优先处理
  - **电源监控保护**：DC_CTRL信号双边沿中断检测，电源异常时保持通道状态，继电器自然断开
  - **高性能特征**：响应时间<500ms，CPU占用<2%，内存占用<1KB
- 核心功能：
  - `SafetyMonitor_CheckAllExceptions()`：全系统异常检测
  - `SafetyMonitor_UpdateAlarmOutputs()`：报警输出控制
  - `SafetyMonitor_CheckExceptionClearConditions()`：异常解除条件检查
  - `SafetyMonitor_PowerFailureCallback()`：电源异常处理回调
- 集成状态：已完全集成到系统控制模块，每500ms执行一次完整检查循环
- 测试验证：通过完整的单元测试和集成测试，参见《3.2_安全监控模块测试说明.md》

---

### 4. 测试验证层开发

#### 4.1 单元测试与集成测试（system_test）
- 目标：为每个模块开发测试用例，确保功能正确、接口稳定。
- 主要内容：
  - 每个功能模块开发完成后，编写对应的测试代码
  - 测试信息通过USART3输出
  - 集成测试各模块协同工作
- 注意事项：
  - 测试代码与主功能代码分离，便于后续维护
  - 测试通过后，删除或注释相关测试代码，保持主代码整洁
- 测试方法：
  - 按模块、按场景逐步测试，记录测试结果
  - 发现问题及时修正并回归测试

#### 4.2 光耦隔离电路测试模块（opto_isolator_test）?**已完成**
- 目标：专门诊断K1_EN、K2_EN、K3_EN光耦隔离电路的工作状态，解决SW1+GND_WB施加DC24V后PB9无法置低电平的问题。
- 主要内容：
  - **实时监测**：连续监测K1_EN、K2_EN、K3_EN信号状态
  - **统计分析**：记录高/低电平占比和状态跳变次数
  - **稳定性检测**：检测信号稳定性和抗干扰能力
  - **智能诊断**：自动分析故障原因并给出修复建议
  - **用户交互**：通过串口命令控制测试过程
- 技术特性：
  - **串口命令控制**：支持init/start/stop/status/check/autotest等命令
  - **自动化测试流程**：60秒完整测试，实时操作指导
  - **智能故障诊断**：自动识别光耦未导通、一直导通、信号不稳定等问题
  - **硬件设计建议**：提供完整的电路设计和元器件选型建议
- 核心功能：
  - `OptoTest_Init()`：初始化测试模块
  - `OptoTest_Start()`：开始指定时长的连续测试
  - `OptoTest_Process()`：测试主循环处理
  - `OptoTest_ManualCheck()`：手动检测信号稳定性
  - `OptoTestMain_AutoTest()`：自动化测试流程
- 使用方法：
  - 串口连接（115200波特率）
  - 运行`autotest`命令进行完整测试
  - 按提示操作：施加/移除DC24V电压
  - 查看诊断结果和修复建议
- 故障诊断能力：
  - 光耦LED电流不足（限流电阻过大）
  - 24V电源问题（电压过低、纹波过大）
  - 光耦CTR过低（器件老化、参数不当）
  - EMI干扰（长线缆、无屏蔽、无滤波）
  - 硬件连接错误（接线、器件方向）
- 测试验证：已完成完整的功能测试，详见《光耦隔离电路测试说明.md》

---

### 5. 开发流程与规范

1. 每开发一个模块，先写.h头文件，定义接口和注释，再写.c实现。
2. 每个函数、结构体、宏定义都要有详细中文注释。
3. 每步开发后，务必通过USART3输出调试和测试信息，便于用户确认。
4. 每个阶段开发完成后，等待用户确认测试通过，才进入下一阶段。
5. 所有自定义文件严格放在Core/Inc和Core/Src目录下，不新建其他文件夹。
6. 参考demo和Doc文件夹资料，确保芯片型号、引脚定义一致。
7. 每次开发和测试结果及时更新README和相关文档。

## 项目开发状态

### 已完成模块：
1. **安全监控模块（safety_monitor）** ?
   - 完成时间：第八阶段开发
   - 功能覆盖：14种异常类型检测、分级报警机制、智能异常解除
   - 性能指标：响应时间<500ms，CPU占用<2%，内存占用<1KB
   - 测试状态：通过完整单元测试和集成测试

2. **光耦隔离电路测试模块（opto_isolator_test）** ?
   - 完成时间：当前阶段开发
   - 功能覆盖：光耦隔离电路诊断、实时监测、智能故障分析
   - 性能指标：支持7种串口命令、60秒自动化测试、完整诊断报告
   - 测试状态：通过完整功能测试，详见《光耦隔离电路测试说明.md》

3. **IWDG看门狗控制模块（iwdg_control）** ?
   - 完成时间：当前阶段开发
   - 功能覆盖：IWDG独立看门狗功能，系统复位保护，安全监控集成
   - 性能指标：3秒超时时间，500ms喂狗间隔，与安全监控系统完全集成
   - 测试状态：通过完整功能测试，包含8项专业测试套件

### 开发中模块：
1. **系统控制模块（system_control）** ?
   - 当前状态：核心功能已完成（自检流程、状态机、主循环调度、安全监控集成）
   - 已实现：四阶段自检检测、精确时序控制、完整异常处理
   - 待完善：与其他功能模块的集成优化

### 待开发模块：
1. **继电器控制模块（relay_control）** ?
2. **温度监控模块（temperature_monitor）** ?  
3. **OLED显示模块（oled_display）** ?
4. **GPIO控制模块（gpio_control）** ?

---

## 附录：O类异常（外部电源监控）详细说明

### 功能概述
O类异常是系统的电源监控保护功能，通过DC_CTRL信号（PB5引脚）实时监控DC24V外部电源状态。当检测到电源异常时，系统立即触发O类异常报警，确保系统在电源故障时的安全运行。

### 硬件接口
- **监控引脚**: DC_CTRL (PB5)
- **中断配置**: 上升沿和下降沿双边沿检测，内部上拉，优先级2
- **电平定义**:
  - **低电平 (0)**: 有DC24V供电 - 正常状态
  - **高电平 (1)**: 没有DC24V供电 - 异常状态

### 检测机制

#### 1. 双重检测保护
- **中断检测**: DC_CTRL信号变化时立即触发中断处理
- **轮询检测**: 主循环每100ms检测一次电源状态
- **响应时间**: <200ms，确保电源异常的快速响应

#### 2. 异常触发条件
- **电源中断**: DC_CTRL从低电平变为高电平
- **检测方式**: 中断触发 + 轮询确认
- **触发动作**: 立即设置O类异常标志

#### 3. 异常解除条件
- **电源恢复**: DC_CTRL恢复到低电平
- **稳定确认**: 电源稳定后自动解除异常（无需延时确认）
- **解除机制**: 基于实时状态检测，避免误报

### 安全保护措施

#### 1. 电源异常时的系统响应
- **状态保持**: 保持当前通道状态，不强制关闭继电器
- **自然断开**: 继电器在DC24V断电时会自然断开，无需主动控制
- **操作阻止**: 电源异常期间阻止所有继电器开启操作
- **错误返回**: 继电器操作返回`RELAY_ERR_POWER_FAILURE`错误码

#### 2. 报警机制
- **异常类型**: O类异常，属于A、N、O类（1秒间隔脉冲）
- **ALARM输出**: 立即输出低电平
- **蜂鸣器**: 1秒间隔脉冲（25ms低电平 + 975ms高电平）
- **OLED显示**: 顶部显示"O异常:DC24V电源中断"

#### 3. 优先级管理
- **异常优先级**: 属于第三优先级（冲突/自检/电源异常）
- **显示优先级**: 在OLED上按优先级显示，确保重要异常优先显示
- **报警统一**: 任何异常都会触发ALARM引脚输出

### 技术实现

#### 1. 核心函数
- `SafetyMonitor_PowerFailureCallback()`: 电源异常中断回调处理
- `SafetyMonitor_CheckPowerMonitor()`: 电源状态轮询检测
- `SafetyMonitor_CheckAlarmO_ClearCondition()`: O类异常解除条件检查

#### 2. 状态管理
- **异常标志**: ALARM_FLAG_O (位15)
- **描述信息**: "DC24V电源中断" / "DC24V电源异常"
- **状态位图**: 使用16位标志位图高效管理

#### 3. 中断配置
```c
// GPIO中断配置
GPIO_InitStruct.Pin = DC_CTRL_Pin;
GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING_FALLING;  // 双边沿检测
GPIO_InitStruct.Pull = GPIO_PULLUP;                  // 内部上拉
```

### 测试验证

#### 1. 功能测试要点
- [ ] 正常供电时DC_CTRL为低电平，无O类异常
- [ ] 断开DC24V时立即触发O类异常
- [ ] 恢复DC24V时自动解除O类异常
- [ ] 电源异常期间阻止继电器开启操作

#### 2. 报警测试要点
- [ ] ALARM引脚正确输出（异常时低电平）
- [ ] 蜂鸣器1秒间隔脉冲正确
- [ ] OLED显示"O异常:DC24V电源中断"
- [ ] 串口输出详细调试信息

#### 3. 安全测试要点
- [ ] 电源异常时通道状态保持不变
- [ ] 继电器自然断开，无强制控制
- [ ] 系统状态正确切换到ALARM状态
- [ ] 电源恢复后系统正常运行

### 故障排查

#### 1. 常见问题
- **无报警响应**: 检查DC_CTRL信号线连接，确认硬件电路正常
- **误报警**: 检查DC24V电源质量，避免电压波动
- **异常不解除**: 确认电源稳定，检查中断配置

#### 2. 调试方法
- **串口监控**: 观察DC_CTRL状态变化和异常检测日志
- **万用表测量**: 检查PB5引脚电压变化
- **示波器分析**: 分析DC_CTRL信号质量和稳定性

### 设计特点

#### 1. 安全设计
- **保守策略**: 电源异常时保持当前状态，避免误动作
- **自然保护**: 依靠继电器自然断开特性，无需强制控制
- **双重检测**: 中断+轮询双重保护，确保检测可靠性

#### 2. 用户友好
- **即时响应**: 电源异常立即报警，响应时间<200ms
- **清晰提示**: OLED和串口提供详细的异常信息
- **自动恢复**: 电源恢复后自动解除异常，无需手动操作

#### 3. 系统集成
- **无缝集成**: 与安全监控系统完全集成
- **统一管理**: 使用相同的异常管理框架
- **一致性**: 报警机制与其他异常保持一致

---

**注意**: O类异常是系统安全保护的重要组成部分，确保在外部电源故障时系统能够安全运行。测试时请严格按照测试要点执行，确保所有功能正常工作。

---

## 附录：IWDG看门狗控制模块详细说明

### 功能概述
IWDG看门狗控制模块是系统的高可靠性保护功能，采用STM32F103的独立看门狗(IWDG)外设实现。为高安全级别的工业控制系统提供系统复位保护，防止程序跑飞、死锁等异常情况。

### 硬件特性
- **看门狗类型**: IWDG（独立看门狗）
- **时钟源**: LSI（40kHz低速内部振荡器）
- **预分频器**: 64（40kHz/64 = 625Hz）
- **重装载值**: 1875（1875/625Hz = 3秒）
- **超时时间**: 3秒（适合工业控制应用）
- **喂狗间隔**: 500ms（安全监控周期的5倍）

### 核心特性

#### 1. 高可靠性设计
- **独立时钟源**: LSI时钟不依赖系统时钟，即使主时钟故障也能正常工作
- **抗干扰能力强**: 适合高压环境的抗干扰要求
- **一旦启动持续运行**: 看门狗启动后无法停止，只能通过停止喂狗来触发复位

#### 2. 智能喂狗机制
- **条件喂狗**: 只有在系统正常状态下才进行喂狗
- **安全检查**: 集成安全监控系统，异常时自动停止喂狗
- **自动调度**: 在主循环调度器中自动处理喂狗逻辑

#### 3. 安全监控集成
- **实时检查**: 检查系统状态和安全监控报警
- **智能暂停**: 检测到严重异常时自动暂停喂狗
- **分级处理**: 对不同级别的异常采用不同的喂狗策略

### 状态管理

#### 1. 看门狗状态
```c
typedef enum {
    IWDG_STATE_DISABLED = 0,    // 看门狗未启用
    IWDG_STATE_ENABLED,         // 看门狗已启用
    IWDG_STATE_FEEDING,         // 正在喂狗
    IWDG_STATE_SUSPENDED        // 喂狗被暂停（异常状态）
} IwdgState_t;
```

#### 2. 复位原因检测
```c
typedef enum {
    IWDG_RESET_NONE = 0,        // 无复位
    IWDG_RESET_UNKNOWN,         // 未知复位原因
    IWDG_RESET_POWER_ON,        // 上电复位
    IWDG_RESET_SOFTWARE,        // 软件复位
    IWDG_RESET_WATCHDOG,        // 看门狗复位
    IWDG_RESET_WINDOW_WATCHDOG, // 窗口看门狗复位
    IWDG_RESET_LOW_POWER,       // 低功耗复位
    IWDG_RESET_PIN              // 引脚复位
} IwdgResetReason_t;
```

### 安全策略

#### 1. 系统状态检查
- **自检阶段**: 在系统自检期间暂停喂狗，给自检流程充分时间
- **错误状态**: 系统错误状态下停止喂狗，允许系统复位
- **温度异常**: K~M类温度异常时停止喂狗，防止过热损坏

#### 2. 启动策略
- **延迟启动**: 系统启动后延迟5秒再启动看门狗
- **自检后启动**: 确保所有模块初始化完成后再启动
- **安全确认**: 只有在系统安全状态下才启动看门狗

#### 3. 异常处理
- **复位恢复**: 看门狗复位后自动分析复位原因
- **频繁复位检测**: 监控复位频率，防止无限复位循环
- **恢复延时**: 复位后给系统额外的稳定时间

### 统计监控

#### 1. 运行统计
```c
typedef struct {
    uint32_t feed_count;            // 喂狗次数
    uint32_t suspend_count;         // 暂停次数
    uint32_t resume_count;          // 恢复次数
    uint32_t last_feed_time;        // 上次喂狗时间
    uint32_t last_suspend_time;     // 上次暂停时间
    uint32_t total_run_time;        // 总运行时间
    uint32_t total_suspend_time;    // 总暂停时间
    IwdgResetReason_t last_reset_reason;  // 上次复位原因
} IwdgStatistics_t;
```

#### 2. 监控功能
- **实时状态**: 实时显示看门狗运行状态
- **统计信息**: 详细的运行统计和历史记录
- **调试模式**: 支持调试模式，详细输出喂狗信息

### 核心API

#### 1. 初始化和控制
```c
void IwdgControl_Init(void);                    // 初始化看门狗控制模块
void IwdgControl_Start(void);                   // 启动看门狗
void IwdgControl_Feed(void);                    // 手动喂狗
void IwdgControl_Suspend(void);                 // 暂停自动喂狗
void IwdgControl_Resume(void);                  // 恢复自动喂狗
```

#### 2. 状态查询
```c
IwdgState_t IwdgControl_GetState(void);         // 获取当前状态
uint8_t IwdgControl_IsAutoFeedEnabled(void);    // 检查自动喂狗状态
IwdgResetReason_t IwdgControl_GetLastResetReason(void);  // 获取复位原因
```

#### 3. 系统集成
```c
void IwdgControl_ProcessAutoFeed(void);         // 处理自动喂狗（主循环调用）
void IwdgControl_SafetyMonitorIntegration(void); // 安全监控集成
uint8_t IwdgControl_IsSystemSafeToFeed(void);   // 检查系统是否安全
```

### 测试验证

#### 1. 功能测试套件
- **基本初始化测试**: 验证初始化和配置正确性
- **启动和喂狗测试**: 验证基本启动和喂狗功能
- **自动喂狗机制测试**: 验证自动喂狗逻辑
- **安全监控集成测试**: 验证与安全监控系统的集成
- **状态转换测试**: 验证状态机转换逻辑
- **统计和监控测试**: 验证统计信息和监控功能
- **配置更改测试**: 验证参数配置功能
- **调试模式测试**: 验证调试功能

#### 2. 测试API
```c
uint8_t IwdgTest_RunFullTestSuite(void);        // 运行完整测试套件
uint8_t IwdgTest_QuickFunctionTest(void);       // 快速功能验证
void IwdgTest_RunResetTest(void);               // 复位测试（危险操作）
```

#### 3. 测试要点
- [ ] 看门狗正确启动，状态切换正常
- [ ] 自动喂狗机制工作正常
- [ ] 安全监控集成正确，异常时正确暂停喂狗
- [ ] 复位原因检测准确
- [ ] 统计信息记录正确
- [ ] 调试输出信息完整

### 使用指南

#### 1. 基本使用
```c
// 在main函数中初始化
IwdgControl_Init();

// 延迟后启动看门狗
HAL_Delay(5000);
IwdgControl_Start();

// 在主循环调度器中处理
IwdgControl_ProcessAutoFeed();
IwdgControl_SafetyMonitorIntegration();
```

#### 2. 调试使用
```c
// 启用调试模式
IwdgControl_EnableDebugMode();

// 查看状态信息
IwdgControl_PrintStatus();
IwdgControl_PrintStatistics();
IwdgControl_PrintResetReason();

// 运行测试
IwdgTest_RunFullTestSuite();
```

### 注意事项

#### 1. 安全提醒
- **IWDG一旦启动无法停止**: 只能通过停止喂狗来触发复位
- **复位测试危险**: 测试复位功能将导致系统复位，谨慎使用
- **调试模式影响**: 调试模式会输出大量信息，正式运行时应禁用

#### 2. 最佳实践
- **合理的超时时间**: 3秒超时时间适合大多数工业应用
- **适当的喂狗间隔**: 500ms间隔确保及时喂狗
- **集成安全监控**: 充分利用安全监控系统，实现智能喂狗

#### 3. 故障排查
- **频繁复位**: 检查系统是否存在死循环或长时间阻塞
- **喂狗失败**: 检查安全监控系统是否报警
- **状态异常**: 检查系统初始化顺序和时序

### 设计优势

#### 1. 高可靠性
- **硬件级保护**: 基于硬件看门狗，可靠性极高
- **独立时钟**: 不依赖系统时钟，抗干扰能力强
- **智能喂狗**: 只有系统正常时才喂狗，避免掩盖问题

#### 2. 易于集成
- **模块化设计**: 完全模块化，易于集成到现有系统
- **标准接口**: 提供标准的API接口，使用简单
- **无缝集成**: 与安全监控系统无缝集成

#### 3. 可维护性
- **详细统计**: 提供完整的运行统计信息
- **调试支持**: 丰富的调试功能和测试套件
- **文档完整**: 详细的使用文档和API说明

---

**注意**: IWDG看门狗是系统安全保护的最后一道防线，确保在程序异常时能够及时复位系统。使用时请严格按照安全策略执行，确保系统的高可靠性运行。


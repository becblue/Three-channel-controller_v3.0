# 外部电源监控BUG修复说明

## 问题描述
用户反馈：拔掉DC24V供电后，系统没有触发警报和异常。

## 原因分析
经过代码分析，发现以下问题：

1. **缺少O类异常标志**：原系统只有A~N共14种异常标志，缺少专门的电源异常标志
2. **中断回调不完整**：DC_CTRL中断只打印调试信息，没有调用安全监控模块
3. **电源监控逻辑缺失**：安全监控模块没有实现电源监控检测函数
4. **显示逻辑遗漏**：OLED显示更新中没有包含O类异常的处理

## 修复内容

### 1. 添加O类异常标志
**文件**: `Core/Inc/safety_monitor.h`, `Core/Src/safety_monitor.c`
- 在`AlarmFlag_t`枚举中添加`ALARM_FLAG_O`（外部电源异常）
- 更新异常描述字符串数组，添加"外部电源异常"
- 将O类异常归类为A、N、O类（1秒间隔脉冲）

### 2. 完善电源异常回调函数
**文件**: `Core/Src/safety_monitor.c`
- 重写`SafetyMonitor_PowerFailureCallback()`函数
- 添加DC_CTRL状态检测逻辑
- 实现电源异常时的紧急安全关断功能
- 添加详细的调试输出信息

### 3. 实现电源监控检测函数
**文件**: `Core/Src/safety_monitor.c`
- 新增`SafetyMonitor_CheckPowerMonitor()`函数
- 在主循环中定期检测DC_CTRL状态
- 实现电源异常的自动检测和报警

### 4. 添加O类异常解除条件
**文件**: `Core/Src/safety_monitor.c`
- 新增`SafetyMonitor_CheckAlarmO_ClearCondition()`函数
- 实现电源恢复稳定确认机制（2秒稳定时间）
- 避免电源不稳定导致的频繁报警切换

### 5. 修复GPIO中断处理
**文件**: `Core/Src/gpio.c`
- 在DC_CTRL中断处理中调用`SafetyMonitor_PowerFailureCallback()`
- 添加安全监控模块头文件包含

### 6. 完善OLED显示逻辑
**文件**: `Core/Src/system_control.c`
- 在显示更新函数中添加O类异常的优先级处理
- 确保电源异常能正确显示为"O异常:DC24V电源中断"

## 功能特性

### 电源异常检测
- **检测方式**: DC_CTRL引脚中断 + 定期轮询
- **响应时间**: <500ms
- **异常条件**: DC_CTRL信号为高电平（DC24V供电中断）
- **正常条件**: DC_CTRL信号为低电平（DC24V供电正常）

### 安全保护措施
- **紧急关断**: 立即关闭所有继电器通道
- **状态锁定**: 异常期间阻止通道开启操作
- **报警输出**: ALARM引脚高电平 + 蜂鸣器1秒脉冲

### 电源恢复机制
- **稳定确认**: 电源恢复后需持续2秒低电平
- **自动解除**: 满足条件后自动清除O类异常
- **状态恢复**: 系统恢复正常运行状态

## 测试验证
已创建详细的测试说明文档：`外部电源监控功能测试说明.md`

## 编译状态
? 编译通过，无错误和警告

## 使用说明
1. 烧写最新固件
2. 按照测试说明文档进行功能验证
3. 确认所有测试项目通过后投入使用

## 注意事项
- 电源监控功能默认启用，可通过`SafetyMonitor_EnablePowerMonitor()`控制
- O类异常属于A、N、O类异常，报警方式为1秒间隔脉冲
- 电源恢复后不会自动重启通道，需要手动操作 
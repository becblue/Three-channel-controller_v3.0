# 光耦隔离电路测试说明

## 问题描述

在三通道切换箱控制系统中，当SW1和GND_WB之间施加DC24V电压时，PB9引脚没有置为低电平，导致K1_EN信号无法正常工作。

根据系统设计，真值表如下：
- K1_EN=1: 第一通道关闭状态
- K1_EN=0: 第一通道开启状态

期望行为：当SW1和GND_WB加载DC24V后，光耦隔离电路应该导通，使PB9变为低电平。

## 测试程序功能

本测试程序专门用于诊断光耦隔离电路的工作状态，包括：

1. **实时监测**：连续监测K1_EN、K2_EN、K3_EN信号状态
2. **统计分析**：记录高/低电平占比和状态跳变次数
3. **稳定性检测**：检测信号稳定性和抗干扰能力
4. **智能诊断**：自动分析故障原因并给出修复建议
5. **用户交互**：通过串口命令控制测试过程

## 使用方法

### 1. 编译和烧录

将以下文件加入项目编译：
- `Core/Src/opto_isolator_test.c`
- `Core/Inc/opto_isolator_test.h`
- `Core/Src/opto_isolator_test_main.c`
- `Core/Inc/opto_isolator_test_main.h`

在main.c中添加初始化调用：
```c
#include "opto_isolator_test_main.h"

int main(void)
{
    // ... 其他初始化代码 ...
    
    // 初始化光耦隔离电路测试
    OptoTestMain_Init();
    
    while (1)
    {
        // 运行测试主循环
        OptoTestMain_Process();
        
        // ... 其他主循环代码 ...
    }
}
```

### 2. 串口连接

- 波特率：115200
- 数据位：8
- 停止位：1
- 校验位：无
- 流控：无

### 3. 测试命令

通过串口发送以下命令：

| 命令 | 参数 | 功能 |
|------|------|------|
| `help` | 无 | 显示帮助信息 |
| `init` | 无 | 初始化测试模块 |
| `start` | 时长(秒) | 开始连续测试 |
| `stop` | 无 | 停止当前测试 |
| `status` | 无 | 显示实时状态 |
| `check` | 无 | 手动检测稳定性 |
| `autotest` | 无 | 自动化测试流程 |

### 4. 推荐测试流程

#### 方法一：自动化测试（推荐）
1. 串口发送：`autotest`
2. 按照提示操作：
   - 0-10秒：保持无电压状态
   - 10-30秒：施加DC24V到SW1和GND_WB
   - 30-50秒：移除DC24V电压
   - 50-60秒：再次施加DC24V
3. 查看诊断结果和建议

#### 方法二：手动测试
1. 串口发送：`init`
2. 串口发送：`check`（查看初始状态）
3. 串口发送：`start 60`（开始60秒测试）
4. 在测试期间对SW1+GND_WB施加/移除DC24V
5. 串口发送：`stop`（停止测试并查看结果）

## 诊断结果分析

### 1. 正常工作状态
- 无电压时：K1_EN=1（高电平）
- 有电压时：K1_EN=0（低电平）
- 状态跳变：与电压施加/移除对应
- 诊断：光耦工作正常

### 2. 光耦未导通
- 现象：K1_EN始终为高电平
- 原因：
  - 限流电阻过大，LED电流不足
  - 24V电源电压过低
  - 光耦LED开路或损坏
- 建议：检查电源电压、限流电阻值、光耦器件

### 3. 光耦一直导通
- 现象：K1_EN始终为低电平
- 原因：
  - 光耦输出端短路
  - 下拉电阻过小
  - 光耦内部短路
- 建议：检查输出端电路、下拉电阻、更换光耦

### 4. 信号不稳定
- 现象：K1_EN频繁跳变
- 原因：
  - EMI干扰
  - 接触不良
  - 电源纹波过大
- 建议：检查线缆屏蔽、接地、滤波电容

## 硬件设计建议

### 1. 理想的光耦隔离电路设计

```
DC24V ---[R1]---[LED]---[光耦]---[R2]--- GND
                  |               |
                  |               |--- PB9 (STM32)
                  |
                GND_WB
```

### 2. 推荐元器件参数

- **光耦器件**：EL817或类似型号
- **限流电阻R1**：2.2kΩ (确保10mA LED电流)
- **下拉电阻R2**：10kΩ (提供稳定的高电平)
- **滤波电容**：100nF陶瓷电容（抑制EMI）
- **保护二极管**：TVS二极管（保护输入端）

### 3. 电路计算

**LED电流计算：**
```
I_LED = (V_IN - V_LED) / R1
      = (24V - 1.2V) / 2.2kΩ
      = 10.4mA
```

**输出电压计算：**
```
V_OUT = VCC - I_C × R2
      = 3.3V - (I_LED × CTR) × R2
      = 3.3V - (10.4mA × 100%) × 10kΩ
      = 3.3V - 1.04V = 2.26V (光耦导通时)
```

### 4. 常见问题和解决方案

| 问题 | 现象 | 解决方案 |
|------|------|----------|
| LED电流不足 | 光耦不导通 | 减小R1值或检查24V电源 |
| CTR过低 | 输出电压过高 | 更换光耦或减小R2值 |
| EMI干扰 | 信号不稳定 | 添加滤波电容、使用屏蔽电缆 |
| 接地问题 | 信号漂移 | 检查接地回路、减小接地阻抗 |
| 长线传输 | 信号衰减 | 使用差分信号或增强驱动能力 |

## 故障排除步骤

### 1. 硬件检查
- 用万用表测量24V电源电压
- 检查限流电阻R1阻值
- 检查下拉电阻R2是否存在
- 验证光耦器件型号和方向

### 2. 信号测量
- 用示波器观察PB9信号波形
- 测量光耦输入端电压
- 检查光耦输出端电压

### 3. 电路改进
- 调整限流电阻值
- 添加滤波电容
- 改善接地设计
- 使用屏蔽电缆

### 4. 软件验证
- 运行测试程序验证修复效果
- 记录测试结果
- 确认系统正常工作

## 注意事项

1. **安全提醒**：测试时注意24V电压安全，避免短路
2. **器件保护**：不要超过光耦的最大额定电流
3. **测试环境**：在EMI相对较小的环境中进行测试
4. **数据记录**：保存测试结果用于后续分析
5. **版本控制**：记录硬件版本和软件版本

## 技术支持

如果测试结果仍然无法解决问题，请提供：
- 完整的测试输出日志
- 硬件电路图
- 实际测量的电压值
- 光耦器件型号和规格

通过以上测试程序和分析方法，应该能够准确定位光耦隔离电路的问题并找到解决方案。 
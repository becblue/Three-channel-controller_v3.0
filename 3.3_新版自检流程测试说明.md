# 3.3 新版自检流程测试说明

## ? 测试目标

验证根据更新后的README要求实现的新版四步自检流程：
1. **第一步：期望状态识别**
2. **第二步：继电器状态检查与主动纠错**  
3. **第三步：接触器状态检查与报错**
4. **第四步：温度安全检测**

## ? 测试环境准备

### 硬件要求
- STM32F103RCT6开发板
- OLED显示屏（I2C接口）
- 继电器模块（6路，带状态反馈）
- 接触器模块（3路，带状态反馈）
- NTC温度传感器（3路）
- 串口调试工具

### 软件要求
- 编译器：Keil MDK-ARM
- 串口波特率：115200
- 调试工具：串口助手

## ? 测试流程

### **第一步：编译和烧写**

1. **编译项目**：
   ```
   打开Keil项目 → Build → 确认无编译错误
   ```

2. **烧写固件**：
   ```
   连接ST-Link → Download → 确认烧写成功
   ```

3. **连接串口**：
   ```
   波特率：115200
   数据位：8
   停止位：1
   校验位：无
   ```

### **第二步：基本启动测试**

上电后观察串口输出：

```
系统控制模块初始化完成
开始LOGO显示阶段，持续时间: 2秒
开始自检阶段，持续时间: 3秒
=== 执行通道关断确认（自检前安全检查） ===
当前通道状态: CH1=OFF, CH2=OFF, CH3=OFF
所有通道已处于关断状态，无需关断操作
=== 通道关断确认完成 ===
自检进度: 0%~100%
开始执行自检检测
=== 开始新版系统自检检测（四步流程） ===
```

**OLED显示验证**：
- 0-2秒：显示公司LOGO
- 2-5秒：显示进度条（0%→100%）

### **第三步：新版四步自检流程测试**

#### **3.1 第一步：期望状态识别测试**

**正常情况测试**：

```
自检步骤1：期望状态识别（25%）
=== 第一步：识别当前期望状态 ===
K_EN信号状态: K1_EN=1, K2_EN=1, K3_EN=1
识别结果：全部关断状态
```

**异常情况测试**（手动制造）：
- 在启动时拉低K1_EN信号
- 预期输出：`识别结果：Channel_1打开状态`
- 或制造无效组合，预期：`识别结果：状态异常（不符合真值表）`

#### **3.2 第二步：继电器纠错测试**

**正常情况测试**：

```
自检步骤2：继电器纠错（50%）
=== 第二步：继电器状态检查与主动纠错 ===
继电器状态: K1_1=0 K1_2=0 K2_1=0 K2_2=0 K3_1=0 K3_2=0
继电器状态正常，无需纠正
```

**纠错功能测试**（手动制造）：
- 手动拉高某个继电器反馈信号
- 预期输出纠错过程：
```
Channel_1继电器状态错误，进行纠正
Channel_1继电器纠正成功
```
- 或纠正失败的情况：
```
Channel_1继电器纠正失败
```

#### **3.3 第三步：接触器检查测试**

**正常情况测试**：

```
自检步骤3：接触器检查（75%）
=== 第三步：接触器状态检查与报错 ===
接触器状态: SW1=0 SW2=0 SW3=0
接触器状态检查：正常
```

**异常情况测试**（手动制造）：
- 手动拉高某个接触器反馈信号
- 预期输出：
```
Channel_1接触器状态异常
接触器状态检查：异常（系统无法主动纠正）
```

#### **3.4 第四步：温度安全检测测试**

**正常情况测试**：

```
自检步骤4：温度安全检测（100%）
=== 第四步：温度安全检测 ===
温度安全检测: NTC1=25.3℃, NTC2=26.1℃, NTC3=25.8℃
温度安全检测：正常（所有温度均在60℃以下）
```

**异常情况测试**（模拟高温）：
- 通过加热或修改ADC值模拟≥60℃
- 预期输出：
```
温度安全检测：异常（存在温度≥60℃的传感器）
NTC1温度超限：65.2℃ >= 60℃
```

### **第四步：自检结果验证**

#### **4.1 自检通过情况**

```
自检结果: 通过
=== 系统进入正常运行状态 ===
```

**OLED显示**：切换到主界面（三分区布局）

#### **4.2 自检失败情况**

```
自检结果: 失败
自检错误信息: 期望状态识别异常;继电器纠错异常;
=== 自检异常，产生N异常标志 ===
[安全监控] 异常标志设置: N - 期望状态识别异常;继电器纠错异常;
=== 系统进入错误状态: 自检失败 ===
```

**OLED显示**：显示异常信息 `N异常:期望状态识别异常;继电器纠错异常;`

**安全监控验证**：
- ALARM引脚输出低电平
- 蜂鸣器1秒间隔脉冲（N类异常）

### **第五步：进度条显示验证**

观察OLED进度条是否按步骤正确显示：

```
进度25%  → 第一步完成
进度50%  → 第二步完成  
进度75%  → 第三步完成
进度100% → 第四步完成
```

每步之间有500ms停顿，用户可以清楚看到进度变化。

## ? 测试检查表

- [ ] **编译通过**：无错误无警告
- [ ] **烧写成功**：固件正确下载
- [ ] **串口通信正常**：115200波特率输出正确
- [ ] **LOGO显示**：2秒公司LOGO正常显示
- [ ] **进度条显示**：按步骤显示25%/50%/75%/100%
- [ ] **第一步正常**：期望状态识别输出正确
- [ ] **第二步正常**：继电器状态检查正确
- [ ] **第三步正常**：接触器状态检查正确  
- [ ] **第四步正常**：温度安全检测正确
- [ ] **自检通过**：进入正常运行状态
- [ ] **自检失败处理**：N异常标志正确设置
- [ ] **安全监控集成**：异常报警机制正常
- [ ] **OLED显示切换**：自检完成后正确切换到主界面

## ? 关键验证要点

### 1. 时序验证
- **2秒LOGO** → **按步骤进行的四步检测** → **结果判定**
- 每步之间500ms停顿，确保用户体验

### 2. 纠错机制验证
- **继电器纠错**：能主动纠正，纠错成功/失败都有明确反馈
- **接触器检查**：只检查不纠正，异常时直接失败

### 3. 异常处理验证
- **N异常标志**：自检失败时正确设置
- **安全监控集成**：异常信息正确传递
- **报警机制**：ALARM引脚和蜂鸣器正确响应

### 4. 显示验证
- **进度条**：按百分比正确显示
- **状态切换**：自检完成后正确切换界面
- **异常显示**：失败时正确显示异常信息

## ? 故障排除

### 常见问题

1. **编译错误**：
   - 检查函数声明是否正确添加到头文件
   - 确认所有必要的头文件已包含

2. **自检卡住**：
   - 检查硬件连接
   - 确认GPIO读取函数返回值正确

3. **进度条不显示**：
   - 检查OLED_ShowSelfTestBar函数
   - 确认I2C通信正常

4. **异常标志不生效**：
   - 检查SafetyMonitor_SetAlarmFlag调用
   - 确认安全监控模块已初始化

## ? 测试通过标准

**新版自检流程测试通过的标准：**

1. ? **时序正确**：2秒LOGO → 四步自检 → 结果判定
2. ? **步骤完整**：四个步骤按顺序执行，每步都有明确输出
3. ? **进度显示**：OLED进度条按25%/50%/75%/100%显示
4. ? **纠错机制**：继电器纠错功能正常工作
5. ? **异常处理**：自检失败时N异常标志正确设置
6. ? **安全集成**：安全监控模块正确响应自检异常
7. ? **状态切换**：自检完成后正确进入对应状态

## ? 测试完成后

测试通过后，请回复：**"3.3新版自检流程测试通过"**

这将标志着根据README更新要求的自检流程重构已完成，系统可以进入下一阶段的开发。

---

**注意事项：**
- 测试过程中详细记录串口输出
- 拍摄OLED显示的实际效果
- 如发现任何问题，请及时反馈具体现象 
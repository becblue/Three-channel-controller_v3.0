# 3.2 安全监控模块测试说明

## ? 模块概述

安全监控模块是三通道高压切换箱控制系统的核心安全保障模块，负责监控系统运行状态并在异常情况下触发相应的报警机制。

## ?? 核心功能

### 1. 异常标志管理（A~N类异常）
- **A类异常**：K1_EN、K2_EN、K3_EN使能冲突
- **B~G类异常**：继电器状态反馈异常（K1_1_STA, K1_2_STA, K2_1_STA, K2_2_STA, K3_1_STA, K3_2_STA）
- **H~J类异常**：接触器状态反馈异常（SW1_STA, SW2_STA, SW3_STA）
- **K~M类异常**：NTC温度超限异常（NTC_1, NTC_2, NTC_3 > 60℃）
- **N类异常**：系统自检异常

### 2. 报警输出系统
- **ALARM引脚**：有任何异常时输出持续低电平
- **蜂鸣器控制**：根据异常类型执行不同的脉冲方式
  - A、N类异常：1秒间隔脉冲（25ms低电平 + 975ms高电平）
  - B~J类异常：50ms间隔脉冲（25ms低电平 + 25ms高电平）
  - K~M类异常：持续低电平输出

### 3. 电源监控
- **DC_CTRL信号监控**：检测外部电源异常
- **电源异常回调**：支持紧急处理机制

## ? 技术架构

### 数据结构设计
```c
// 异常信息结构体
typedef struct {
    uint8_t is_active;      // 异常是否激活
    AlarmType_t type;       // 异常类型（AN/BJ/KM）
    uint32_t trigger_time;  // 异常触发时间
    char description[32];   // 异常描述信息
} AlarmInfo_t;

// 安全监控结构体
typedef struct {
    uint16_t alarm_flags;               // 异常标志位图
    AlarmInfo_t alarm_info[14];         // 详细异常信息
    uint8_t alarm_output_active;        // ALARM引脚状态
    BeepState_t beep_state;             // 蜂鸣器状态
    uint32_t beep_last_toggle_time;     // 蜂鸣器时序控制
    uint8_t beep_current_level;         // 当前蜂鸣器电平
    uint8_t power_monitor_enabled;      // 电源监控使能
} SafetyMonitor_t;
```

### 状态机设计
```
异常检测 → 标志设置 → 输出更新 → 脉冲处理
    ↓         ↓         ↓         ↓
检测逻辑   位图管理   ALARM输出  蜂鸣器时序
    ↓         ↓         ↓         ↓
解除检查   标志清除   状态恢复   停止输出
```

## ? 测试方法

### 1. 异常标志设置测试
```c
// 手动设置异常标志进行测试
SafetyMonitor_SetAlarmFlag(ALARM_FLAG_A, "测试A类异常");
SafetyMonitor_SetAlarmFlag(ALARM_FLAG_K, "测试K类异常");

// 验证：检查标志位图和描述信息
uint16_t flags = SafetyMonitor_GetAlarmFlags();
AlarmInfo_t info = SafetyMonitor_GetAlarmInfo(ALARM_FLAG_A);
```

### 2. 使能冲突检测测试（A类异常）
```c
// 模拟多路使能信号同时为低电平
// 期望结果：触发A类异常，蜂鸣器1秒间隔脉冲
void TestEnableConflict() {
    // 人工设置多个K_EN信号为低电平
    // 观察调试输出中的A类异常信息
}
```

### 3. 继电器状态异常测试（B~G类异常）
```c
// 模拟继电器期望状态与实际反馈不符
// 期望结果：触发B~G类异常，蜂鸣器50ms间隔脉冲
void TestRelayStatusError() {
    // 设置通道为开启状态，但模拟状态反馈为关闭
    RelayControl_SetChannelState(1, RELAY_STATE_ON);
    // 手动修改状态反馈信号，观察B类异常触发
}
```

### 4. 温度异常测试（K~M类异常）
```c
// 模拟NTC温度超过60℃阈值
// 期望结果：触发K~M类异常，蜂鸣器持续低电平
void TestTemperatureAlarm() {
    // 通过加热或修改ADC值模拟高温
    // 观察K~M类异常触发和持续蜂鸣
}
```

### 5. 异常解除测试
```c
// 验证异常解除条件
void TestAlarmClearConditions() {
    // A类异常解除：只能有一路或全部为高电平
    // B~J、N类异常解除：符合触发条件真值表
    // K~M类异常解除：温度降至58℃以下（2℃回差）
}
```

## ? 关键验证要点

### 1. 蜂鸣器脉冲时序验证
- **1秒间隔脉冲**：25ms低电平 + 975ms高电平，周期1000ms
- **50ms间隔脉冲**：25ms低电平 + 25ms高电平，周期50ms
- **持续输出**：恒定低电平，无脉冲

### 2. ALARM引脚逻辑验证
- **正常状态**：ALARM引脚输出高电平
- **任何异常**：ALARM引脚立即切换到低电平
- **异常解除**：ALARM引脚恢复高电平

### 3. 异常优先级验证
- **最高优先级**：K~M类异常（温度异常）
- **中等优先级**：B~J类异常（状态反馈异常）
- **较低优先级**：A、N类异常（使能冲突、自检异常）

### 4. 解除条件逻辑验证
- **A类异常**：使能冲突解除（≤1路低电平）
- **B~J、N类**：恢复到触发条件真值表的正常状态
- **K~M类异常**：温度回降至58℃以下（含2℃回差）

## ? 调试输出示例

### 正常运行输出
```
安全监控模块初始化完成
[安全监控] 异常标志位图: 0x0000
[安全监控] ALARM引脚输出: 高电平（正常）
[安全监控] 蜂鸣器状态: 关闭
```

### 异常触发输出
```
[安全监控] 异常标志设置: A类异常 - K1_EN/K2_EN/K3_EN使能冲突
[安全监控] ALARM引脚输出: 低电平（报警）
[安全监控] 蜂鸣器状态切换: 1秒间隔脉冲
```

### 异常解除输出
```
[安全监控] 异常标志清除: A类异常解除
[安全监控] ALARM引脚输出: 高电平（正常）
[安全监控] 蜂鸣器状态切换: 关闭
```

## ? 模块集成

### 系统控制集成
```c
// 在SystemControl_Init()中初始化
SafetyMonitor_Init();

// 在主循环调度器中处理（每500ms）
SafetyMonitor_Process();
```

### GPIO控制集成
```c
// ALARM引脚控制（PB4）
void GPIO_SetAlarmOutput(uint8_t state);

// 蜂鸣器控制（PB3）
void GPIO_SetBeepOutput(uint8_t state);
```

## ? 性能指标

- **响应时间**：异常检测到输出响应 < 500ms
- **脉冲精度**：时序误差 < ±5ms
- **CPU占用**：安全监控处理 < 2%
- **内存占用**：全部数据结构 < 1KB

## ? 后续优化方向

1. **异常日志记录**：增加异常历史记录功能
2. **远程监控接口**：支持通过串口查询异常状态
3. **自适应阈值**：根据环境条件动态调整报警阈值
4. **故障预测**：基于历史数据进行趋势分析

## ? 验收标准

- [ ] 所有14种异常类型均能正确检测和标记
- [ ] ALARM引脚在异常时立即输出低电平
- [ ] 蜂鸣器按异常类型执行正确的脉冲方式
- [ ] 异常解除条件逻辑完全符合README要求
- [ ] 模块集成后系统运行稳定，无性能影响
- [ ] 调试输出信息清晰，便于故障排查

---

**测试完成标志**：安全监控模块能够在各种异常情况下准确响应，为三通道高压切换箱提供可靠的安全保障机制。 
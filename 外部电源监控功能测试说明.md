# 外部电源监控功能测试说明

## 功能概述
外部电源监控功能通过DC_CTRL信号（PB5引脚）监控DC24V外部电源状态，当检测到电源异常时，系统会立即触发O类异常报警，并执行紧急安全关断操作。

## 硬件连接
- **DC_CTRL引脚**: PB5
- **配置**: 上升沿使能，内部上拉，开启中断，优先级2
- **正常状态**: 低电平（DC24V供电正常）
- **异常状态**: 高电平（DC24V供电中断）

## 测试前准备

### 1. 固件烧写
确保已烧写最新固件（包含外部电源监控功能）

### 2. 串口连接
- 波特率：115200
- 数据位：8
- 停止位：1
- 校验位：无

### 3. 硬件连接确认
确认DC_CTRL信号线正确连接到PB5引脚

## 测试步骤

### 测试1：正常电源状态验证

1. **上电启动系统**
   - 确保DC24V正常供电
   - 观察串口输出，系统正常启动

2. **检查初始状态**
   ```
   预期串口输出：
   === 三通道切换箱控制系统启动 ===
   安全监控模块初始化完成
   电源监控已启用
   ```

3. **验证DC_CTRL状态**
   - 正常情况下DC_CTRL应为低电平
   - 无O类异常报警

### 测试2：电源异常检测

1. **模拟电源中断**
   - 拔掉DC24V供电线
   - 观察系统响应

2. **预期系统响应**
   ```
   预期串口输出：
   DC_CTRL中断触发
   [安全监控] DC_CTRL状态变化: 高电平
   [安全监控] 检测到外部电源异常！DC24V供电中断
   [安全监控] 异常标志设置: O类异常 - DC24V电源中断
   [安全监控] 执行紧急安全关断...
   ```

3. **验证报警响应**
   - **ALARM引脚**: 应输出高电平（持续）
   - **蜂鸣器**: 应输出1秒间隔脉冲
   - **OLED显示**: 顶部应显示"O异常:DC24V电源中断"

4. **验证安全关断**
   - 所有继电器通道应被强制关闭
   - 系统进入安全保护状态

### 测试3：电源恢复检测

1. **恢复电源供电**
   - 重新连接DC24V供电线
   - 观察系统响应

2. **预期系统响应**
   ```
   预期串口输出：
   DC_CTRL中断触发
   [安全监控] DC_CTRL状态变化: 低电平
   [安全监控] 外部电源恢复正常
   [安全监控] 电源开始恢复，等待稳定...
   ```

3. **等待稳定确认**
   - 系统会等待2秒确认电源稳定
   - 2秒后应看到：
   ```
   [安全监控] 电源已稳定恢复，可以解除O类异常
   [安全监控] 异常标志清除: O类异常解除
   ```

4. **验证报警解除**
   - **ALARM引脚**: 恢复低电平（如无其他异常）
   - **蜂鸣器**: 停止输出
   - **OLED显示**: 清除O类异常显示

### 测试4：电源不稳定测试

1. **模拟电源不稳定**
   - 快速插拔DC24V供电线（间隔小于2秒）
   - 观察系统响应

2. **预期行为**
   - 每次电源中断都会触发O类异常
   - 只有持续稳定2秒以上才会解除异常
   - 避免因电源不稳定导致的频繁报警切换

## 测试验证点

### ? 功能正确性
- [ ] 电源正常时无O类异常
- [ ] 电源中断时立即触发O类异常
- [ ] 电源恢复后正确解除异常
- [ ] 紧急关断功能正常工作

### ? 报警响应
- [ ] ALARM引脚输出正确（异常时高电平，正常时低电平）
- [ ] 蜂鸣器1秒间隔脉冲输出正确
- [ ] OLED显示O类异常信息正确

### ? 时序特性
- [ ] 电源异常检测响应时间<500ms
- [ ] 电源恢复稳定确认时间=2秒
- [ ] 紧急关断动作及时执行

### ? 系统安全
- [ ] 电源异常时所有通道被强制关闭
- [ ] 异常状态下阻止通道开启操作
- [ ] 电源恢复后系统状态正确

## 故障排查

### 问题1：拔掉DC24V后无报警
**可能原因**：
- DC_CTRL信号线未正确连接到PB5
- 硬件电路设计问题
- 固件未正确烧写

**排查方法**：
1. 用万用表测量PB5引脚电压变化
2. 检查硬件原理图和PCB连接
3. 确认固件版本包含电源监控功能

### 问题2：电源恢复后异常不解除
**可能原因**：
- 电源不稳定，未持续2秒低电平
- DC_CTRL信号异常

**排查方法**：
1. 检查DC24V电源质量
2. 观察串口输出的电源稳定计时信息
3. 用示波器检查DC_CTRL信号质量

### 问题3：误报警（电源正常但报O类异常）
**可能原因**：
- 硬件电路干扰
- DC_CTRL信号线接触不良

**排查方法**：
1. 检查PCB布线和接地
2. 添加滤波电容
3. 检查连接器接触

## 测试记录

| 测试项目 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|---------|---------|------|------|
| 正常电源状态 | 无O类异常 |  | ? |  |
| 电源中断检测 | 立即触发O类异常 |  | ? |  |
| 紧急安全关断 | 所有通道关闭 |  | ? |  |
| 报警输出 | ALARM高电平+蜂鸣器1秒脉冲 |  | ? |  |
| 电源恢复检测 | 2秒后解除异常 |  | ? |  |
| OLED显示 | 正确显示O类异常信息 |  | ? |  |

## 总结
外部电源监控功能是系统安全保护的重要组成部分，确保在外部电源异常时能够及时响应并执行安全关断，保护设备和人员安全。测试时请严格按照步骤执行，确保所有功能正常工作。 